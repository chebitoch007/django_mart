{% extends "store/base.html" %}
{% load humanize %}
{% load static %}
{% load django_vite %}

{% block title %}Your Shopping Cart - ASAI{% endblock %}

{% block extra_css %}
<!-- Vite will automatically inject CSS from cart-detail.ts -->
{% endblock %}

{% block content %}
<div class="cart-page-container" role="region" aria-labelledby="cart-heading">
    <!-- Header -->
    <div class="cart-page-header">
        <div class="cart-header-content">
            <div class="cart-icon-wrapper" aria-hidden="true">
                <svg class="icon-cart" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M3 3h2l.4 2M7 13h10l4-8H6.4" stroke="currentColor" stroke-width="1.5"
                          stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="10" cy="20" r="1" fill="currentColor"/>
                    <circle cx="18" cy="20" r="1" fill="currentColor"/>
                </svg>
            </div>

            <div>
                <h1 id="cart-heading" class="cart-title">Your Shopping Cart</h1>
                <div class="cart-item-count" aria-live="polite">
                    {{ cart.total_items }} item{{ cart.total_items|pluralize }}
                </div>
            </div>
        </div>

        {% if error_message %}
        <div class="error-notice" role="alert">
            <svg class="icon icon-alert" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 9v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                      stroke-linejoin="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                      stroke-linejoin="round"/>
            </svg>
            <span>{{ error_message }}</span>
        </div>
        {% endif %}
    </div>

    {% if cart.items.exists %}
    <div class="cart-layout">
        <!-- Items Section -->
        <div class="cart-items-section">
            <div class="continue-shopping">
                <a href="{% url 'store:product_list' %}" class="continue-btn">
                    <svg class="icon icon-back" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                         style="width:20px;height:20px;">
                        <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                              stroke-linejoin="round"/>
                    </svg>
                    Continue Shopping
                </a>
            </div>

            {% for item in cart.items.all %}
            {# [NEW] Changed class from cart-item-row to cart-card for consistency #}
            <div class="cart-card {% if not item.product.available %}unavailable{% endif %}"
                 data-product-id="{{ item.product.id }}"
                 data-update-url="{% url 'cart:cart_update' item.product.id %}"
                 data-stock="{{ item.product.stock }}">

                {# [NEW] Loading overlay will be inserted here by JavaScript #}

                <div class="cart-item-content">
                    <a href="{{ item.product.get_absolute_url }}" class="cart-item-image-wrapper" aria-hidden="true">
                        <img src="{{ item.product.get_image_url }}"
                             alt="{{ item.product.name }}"
                             class="cart-item-image"
                             loading="lazy"
                             decoding="async">
                    </a>

                    <div class="cart-item-details">
                        <a href="{{ item.product.get_absolute_url }}" class="cart-item-name">
                            {{ item.product.name }}
                        </a>
                        <div class="cart-item-category">{{ item.product.category }}</div>

                        {% if item.product.discount_price %}
                        <div class="discount-badge" aria-hidden="true">Discount Applied</div>
                        {% endif %}

                        {% if not item.product.available %}
                        <div class="cart-item-unavailable" role="status">
                            <svg class="icon icon-warning" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                                 style="width:16px;height:16px;">
                                <path d="M12 9v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                      stroke-linejoin="round"/>
                                <path d="M12 17h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                      stroke-linejoin="round"/>
                            </svg>
                            Currently Unavailable
                        </div>
                        {% endif %}

                        <div class="product-details-row">
                            <div class="price-quantity-group">
                                <div class="unit-price-block">
                                    <div class="price-primary">KES {{ item.product.get_display_price|intcomma }}</div>
                                    {% if item.product.discount_price %}
                                    <div class="cart-item-original-price">KES {{ item.product.price|intcomma }}</div>
                                    {% endif %}
                                </div>

                                <div class="quantity-control" aria-label="Quantity control for {{ item.product.name }}">
                                    <div class="quantity-form" role="group" aria-label="Adjust quantity">
                                        <button type="button" class="quantity-btn decrease"
                                                aria-label="Decrease quantity"
                                                {% if not item.product.available %}disabled{% endif %}>
                                            <svg class="icon-minus" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                                                 style="width:16px;height:16px;">
                                                <path d="M5 12h14" stroke="currentColor" stroke-width="1.5"
                                                      stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>

                                        <input type="number"
                                               value="{{ item.quantity }}"
                                               min="1"
                                               max="{{ item.product.stock }}"
                                               class="quantity-input"
                                               aria-label="Quantity"
                                               data-original-value="{{ item.quantity }}"
                                               {% if not item.product.available %}disabled{% endif %}>

                                        <button type="button" class="quantity-btn increase"
                                                aria-label="Increase quantity"
                                                {% if not item.product.available %}disabled{% endif %}>
                                            <svg class="icon-plus" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                                                 style="width:16px;height:16px;">
                                                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5"
                                                      stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>

                                    {# [NEW] Static stock warning - dynamic one will be added by JS #}
                                    {% if item.quantity > item.product.stock %}
                                    <div class="stock-warning" role="alert">
                                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"
                                             style="width:14px;height:14px;">
                                            <path d="M12 9v4" stroke="currentColor" stroke-width="1.2"
                                                  stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 17h.01" stroke="currentColor" stroke-width="1.2"
                                                  stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Only {{ item.product.stock }} available
                                    </div>
                                    {% endif %}
                                    {# Dynamic stock warning will be inserted here by JavaScript #}
                                </div>
                            </div>

                            <div class="item-actions">
                                <div class="cart-item-total" id="total-{{ item.product.id }}" aria-live="polite">
                                    KES {{ item.total_price|intcomma }}
                                </div>

                                <form method="post" action="{% url 'cart:cart_remove' item.product.id %}"
                                      class="cart-remove-form" aria-label="Remove {{ item.product.name }}">
                                    {% csrf_token %}
                                    <button type="submit" class="cart-remove-btn" aria-label="Remove item">
                                        <svg class="icon-trash" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                            <path d="M3 6h18" stroke="currentColor" stroke-width="1.2"
                                                  stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="currentColor"
                                                  stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.2"
                                                  stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if cart_has_stock_issues %}
            <div class="stock-notice" role="alert">
                <svg class="icon-warning" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                     style="width:24px;height:24px;">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                          stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 9v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                          stroke-linejoin="round"/>
                    <path d="M12 17h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                          stroke-linejoin="round"/>
                </svg>
                <div class="notice-content">
                    <h3>Stock Issues Detected</h3>
                    <p>Some items in your cart exceed available stock. Quantities have been adjusted to maximum
                        available.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Summary Section -->
        <div class="cart-summary-section">
            <div class="summary-card" id="cart-summary" aria-labelledby="summary-title">
                <div class="summary-content">
                    <h3 id="summary-title" class="summary-title">Order Summary</h3>

                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal" aria-live="polite">KES {{ cart.total_price|intcomma }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span>Calculated at checkout</span>
                    </div>
                    <div class="summary-row">
                        <span>Estimated Tax:</span>
                        <span>KES 0.00</span>
                    </div>

                    <div class="summary-total-row" aria-live="polite">
                        <span>Total:</span>
                        <span id="cart-total">KES {{ cart.total_price|intcomma }}</span>
                    </div>

                    <form method="post" action="{% url 'cart:cart_detail' %}">
                        {% csrf_token %}
                        <button type="submit" name="checkout" class="checkout-btn" {% if not cart.items.exists %}disabled{% endif %}>
                            Proceed to Checkout
                        </button>
                    </form>

                    <div class="payment-methods" aria-hidden="true">
                        <div class="payment-method" title="M-Pesa">M-Pesa</div>
                        <div class="payment-method" title="Visa">VISA</div>
                        <div class="payment-method" title="MasterCard">MC</div>
                        <div class="payment-method" title="PayPal">PayPal</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty cart -->
    <div class="empty-cart-container" role="status" aria-live="polite">
        <div class="empty-cart-icon" aria-hidden="true">
            <svg class="icon-cart-lg" viewBox="0 0 24 24" fill="none">
                <path d="M3 3h2l.4 2M7 13h10l4-8H6.4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"
                      stroke-linejoin="round"/>
                <circle cx="10" cy="20" r="1" fill="currentColor"/>
                <circle cx="18" cy="20" r="1" fill="currentColor"/>
            </svg>
        </div>

        <h2 class="empty-cart-title">Your Cart is Empty</h2>
        <p class="empty-cart-text">Explore our premium products and find something special for your gaming setup!</p>
        <a href="{% url 'store:product_list' %}" class="discover-btn">
            <svg class="icon-bag" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:20px;height:20px;">
                <path d="M6 7V6a6 6 0 0 1 12 0v1" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"
                      stroke-linejoin="round"/>
                <path d="M3 7h18l-1 13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2L3 7z" stroke="currentColor" stroke-width="1.2"
                      stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Discover Products
        </a>

        <div class="recently-viewed">
            <h3 class="recently-viewed-title">Recently Viewed</h3>
            <div class="recent-products">
                {% for product in recently_viewed|slice:":3" %}
                <a href="{{ product.get_absolute_url }}" class="recent-product" aria-label="{{ product.name }}">
                    <img src="{{ product.get_image_url }}" alt="{{ product.name }}" loading="lazy" decoding="async">
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

{# [NEW] Toast container and sticky bar will be added by JavaScript #}

{% endblock %}


{% block extra_scripts %}
{% vite_asset 'src/cart/cart-detail.ts' %}
{% endblock %}