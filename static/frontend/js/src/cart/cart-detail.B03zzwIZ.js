class l{csrfToken;activeRequests=new Set;toastContainer=null;currencyCode="KES";currencySymbol="KSh";constructor(){console.log("üõí CartManager initialized"),this.csrfToken=this.getCSRFToken(),this.detectCurrency(),this.initToastContainer(),this.initEventListeners(),this.initStickyCheckoutBar()}detectCurrency(){const e=document.getElementById("cart-subtotal");if(!e){console.warn("‚ö†Ô∏è Could not find cart-subtotal element");return}const t=e.textContent||"";console.log("üí∞ Analyzing currency from text:",t);const o=t.match(/[A-Z]{3}/);o&&(this.currencyCode=o[0]);const n=t.match(/[$‚Ç¨¬£¬•‚ÇπKSh‚Ç¶‚Çµ]/);n?this.currencySymbol=n[0]:this.currencySymbol=this.currencyCode,console.log(`‚úÖ Currency detected: ${this.currencyCode} (${this.currencySymbol})`)}formatPrice(e){const t=["$","¬£","‚Ç¨"].includes(this.currencySymbol),o=this.formatNumber(e);return t?`${this.currencySymbol}${o}`:`${this.currencyCode} ${o}`}parsePrice(e){const t=e.replace(/[^0-9.-]/g,""),o=parseFloat(t);return isNaN(o)?0:o}formatNumber(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}getCSRFToken(){const e=document.querySelector("[name=csrfmiddlewaretoken]");if(!e)throw console.warn("‚ö†Ô∏è CSRF token not found"),new Error("CSRF token not found");return e.value}initToastContainer(){this.toastContainer=document.createElement("div"),this.toastContainer.className="toast-container",this.toastContainer.setAttribute("aria-live","polite"),this.toastContainer.setAttribute("aria-atomic","true"),document.body.appendChild(this.toastContainer)}initStickyCheckoutBar(){const e=document.getElementById("cart-total")?.textContent||this.formatPrice(0);if(!(document.querySelectorAll(".cart-card").length>0))return;const o=document.createElement("div");o.className="sticky-checkout-bar",o.innerHTML=`
            <div class="sticky-checkout-content">
                <div class="sticky-total">
                    <span class="sticky-label">Total:</span>
                    <span class="sticky-amount" id="sticky-cart-total">${e}</span>
                </div>
                <button type="button" class="sticky-checkout-btn" onclick="document.querySelector('.checkout-btn')?.click()">
                    Checkout
                </button>
            </div>
        `,document.body.appendChild(o)}initEventListeners(){console.log("üéØ Initializing event listeners"),document.querySelectorAll(".quantity-btn").forEach(e=>{e.addEventListener("click",t=>this.handleQuantityButtonClick(t))}),document.querySelectorAll(".quantity-input").forEach(e=>{e.addEventListener("change",t=>this.handleQuantityInputChange(t))}),document.querySelectorAll(".cart-remove-form").forEach(e=>{e.addEventListener("submit",t=>this.handleRemoveItem(t))}),console.log("‚úÖ Event listeners initialized")}handleQuantityButtonClick(e){const t=e.currentTarget,n=t.closest(".quantity-form")?.querySelector(".quantity-input"),a=t.closest(".cart-card");if(!n||!a){console.warn("‚ö†Ô∏è Could not find input or row for quantity button");return}let r=parseInt(n.value)||1;t.classList.contains("increase")?r++:t.classList.contains("decrease")&&r>1&&r--,n.value=r.toString();const s=a.getAttribute("data-product-id");if(!s){console.error("‚ùå productId missing on cart row");return}console.log(`üì¶ Updating product ${s} to quantity ${r}`),this.updateCartItem(s,r,n,a).catch(i=>{console.error("‚ùå updateCartItem failed:",i)})}handleQuantityInputChange(e){const t=e.currentTarget,o=t.closest(".cart-card");if(!o){console.warn("‚ö†Ô∏è Could not find row for quantity input");return}let n=parseInt(t.value)||1;(isNaN(n)||n<1)&&(n=1);const a=parseInt(t.max)||parseInt(o.getAttribute("data-stock")||"0");n>a?(n=a,this.showStockWarning(o,a)):this.hideStockWarning(o),t.value=n.toString();const r=o.getAttribute("data-product-id");if(!r){console.error("‚ùå productId missing on cart row");return}console.log(`üì¶ Updating product ${r} to quantity ${n}`),this.updateCartItem(r,n,t,o).catch(s=>{console.error("‚ùå updateCartItem failed:",s),t.value=t.getAttribute("data-original-value")||"1"})}async updateCartItem(e,t,o,n){if(this.activeRequests.has(e)){console.log(`‚è≥ Request already in progress for product ${e}`);return}this.activeRequests.add(e),this.showLoadingOverlay(n);try{const a=n.getAttribute("data-update-url")||`/cart/update/${e}/`;console.log(`üîÑ Updating cart: URL=${a}, quantity=${t}`);const r=new FormData;r.append("quantity",t.toString()),r.append("csrfmiddlewaretoken",this.csrfToken);const s=await fetch(a,{method:"POST",body:r,headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP ${s.status}`);const i=await s.json();console.log("üì• Server response:",i),i.success?(await this.updateCartUI(i,e,o),this.showToast({message:"Cart updated successfully",type:"success"})):i.message&&this.showToast({message:i.message,type:"error"})}catch(a){console.error("‚ùå updateCartItem failed:",a),this.showToast({message:"Error updating cart",type:"error"}),o.value=o.getAttribute("data-original-value")||"1"}finally{this.hideLoadingOverlay(n),this.activeRequests.delete(e)}}async updateCartUI(e,t,o){const n=document.getElementById(`total-${t}`);n&&(n.textContent=e.item_total),await this.updateCartTotals(e.cart_total_price),this.updateCartCount(e.cart_total_items),o.max=e.product_stock.toString(),o.value=e.item_quantity.toString(),o.setAttribute("data-original-value",e.item_quantity.toString())}async updateCartTotals(e){const t=document.getElementById("cart-subtotal"),o=document.getElementById("cart-total"),n=document.getElementById("sticky-cart-total");for(const a of[t,o,n])a&&(a.style.transform="scale(1.1)",a.style.transition="transform 0.2s ease",a.textContent=e,setTimeout(()=>{a.style.transform="scale(1)"},200))}updateCartCount(e){const t=document.querySelector(".cart-item-count");if(t){const n=e===1?"item":"items";t.textContent=`${e} ${n}`}const o=document.getElementById("cart-count");o&&(o.textContent=e.toString())}async handleRemoveItem(e){e.preventDefault();const t=e.currentTarget,o=t.closest(".cart-card");if(o){this.showLoadingOverlay(o);try{const a=await(await fetch(t.action,{method:"POST",body:new FormData(t),headers:{"X-Requested-With":"XMLHttpRequest"}})).json();a.success&&(await this.removeCartItemRow(o,a),this.showToast({message:"Item removed from cart",type:"success"}))}catch{this.showToast({message:"Error removing item",type:"error"})}finally{this.hideLoadingOverlay(o)}}}async removeCartItemRow(e,t){e.classList.add("removing"),await new Promise(o=>setTimeout(o,400)),e.remove(),await this.updateCartTotals(t.cart_total_price),this.updateCartCount(t.cart_total_items),t.cart_total_items===0&&location.reload()}showToast(e){const{message:t,type:o,duration:n=3e3}=e;if(!this.toastContainer)return;const a=document.createElement("div");a.className=`toast toast-${o}`,a.setAttribute("role",o==="error"?"alert":"status"),a.innerHTML=`
            <div class="toast-icon">${this.getToastIcon(o)}</div>
            <div class="toast-message">${t}</div>
        `,this.toastContainer.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.classList.add("hide"),setTimeout(()=>a.remove(),300)},n)}getToastIcon(e){const t={success:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/></svg>`,error:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>`,warning:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/></svg>`};return t[e]||t.success}showLoadingOverlay(e){if(e.querySelector(".loading-overlay"))return;const t=document.createElement("div");t.className="loading-overlay",t.innerHTML='<div class="loading-spinner"><div class="spinner"></div></div>',e.appendChild(t)}hideLoadingOverlay(e){const t=e.querySelector(".loading-overlay");t&&t.remove()}showStockWarning(e,t){const o=e.querySelector(".quantity-control");if(!o||o.querySelector(".stock-warning-dynamic"))return;const n=document.createElement("div");n.className="stock-warning-dynamic",n.innerHTML=`
            <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
                <path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="1.2"/></svg>
            Only ${t} available
        `,o.appendChild(n),setTimeout(()=>n.classList.add("show"),10)}hideStockWarning(e){const t=e.querySelector(".stock-warning-dynamic");t&&(t.classList.remove("show"),setTimeout(()=>t.remove(),300))}}document.addEventListener("DOMContentLoaded",()=>{try{window.cartManager=new l}catch(c){console.error("üí• Failed to initialize CartManager:",c)}});
