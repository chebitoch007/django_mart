class p{csrfToken;activeRequests=new Set;toastContainer=null;currencySymbol="KES ";constructor(){console.log("üõí CartManager initialized"),this.csrfToken=this.getCSRFToken(),this.detectCurrencySymbol(),this.initToastContainer(),this.initEventListeners(),this.initStickyCheckoutBar()}detectCurrencySymbol(){const t=(document.getElementById("cart-subtotal")?.textContent||"").match(/[A-Z]{3}/);t?(this.currencySymbol=`${t[0]} `,console.log(`üí± Detected currency: ${this.currencySymbol}`)):console.warn("‚ö†Ô∏è No currency code detected, using default KES")}getCSRFToken(){const e=document.querySelector("[name=csrfmiddlewaretoken]");if(!e)throw console.warn("‚ö†Ô∏è CSRF token not found"),new Error("CSRF token not found");return e.value}initToastContainer(){this.toastContainer=document.createElement("div"),this.toastContainer.className="toast-container",this.toastContainer.setAttribute("aria-live","polite"),this.toastContainer.setAttribute("aria-atomic","true"),document.body.appendChild(this.toastContainer)}initStickyCheckoutBar(){const e=document.getElementById("cart-total")?.textContent||`${this.currencySymbol}0`;if(!(document.querySelectorAll(".cart-card").length>0))return;const o=document.createElement("div");o.className="sticky-checkout-bar",o.innerHTML=`
            <div class="sticky-checkout-content">
                <div class="sticky-total">
                    <span class="sticky-label">Total:</span>
                    <span class="sticky-amount" id="sticky-cart-total">${e}</span>
                </div>
                <button type="button" class="sticky-checkout-btn" onclick="document.querySelector('.checkout-btn')?.click()">
                    Checkout
                </button>
            </div>
        `,document.body.appendChild(o)}initEventListeners(){console.log("üéØ Initializing event listeners"),document.querySelectorAll(".quantity-btn").forEach(e=>{e.addEventListener("click",t=>this.handleQuantityButtonClick(t))}),document.querySelectorAll(".quantity-input").forEach(e=>{e.addEventListener("change",t=>this.handleQuantityInputChange(t))}),document.querySelectorAll(".cart-remove-form").forEach(e=>{e.addEventListener("submit",t=>this.handleRemoveItem(t))}),console.log("‚úÖ Event listeners initialized")}handleQuantityButtonClick(e){const t=e.currentTarget,a=t.closest(".quantity-form")?.querySelector(".quantity-input"),n=t.closest(".cart-card");if(!a||!n){console.warn("‚ö†Ô∏è Could not find input or row for quantity button");return}let r=parseInt(a.value)||1;t.classList.contains("increase")?r++:t.classList.contains("decrease")&&r>1&&r--,a.value=r.toString();const s=n.getAttribute("data-product-id");if(!s){console.error("‚ùå productId missing on cart row (data-product-id)"),console.log("Row element:",n);return}console.log(`üì¶ Updating product ${s} to quantity ${r}`),this.updateCartItem(s,r,a,n).catch(i=>{console.error("‚ùå updateCartItem failed:",i)})}handleQuantityInputChange(e){const t=e.currentTarget,o=t.closest(".cart-card");if(!o){console.warn("‚ö†Ô∏è Could not find row for quantity input");return}let a=parseInt(t.value)||1;(isNaN(a)||a<1)&&(a=1);const n=parseInt(t.max)||parseInt(o.getAttribute("data-stock")||"0");a>n?(a=n,this.showStockWarningDynamic(o,n)):this.hideStockWarningDynamic(o),t.value=a.toString();const r=o.getAttribute("data-product-id");if(!r){console.error("‚ùå productId missing on cart row (data-product-id)");return}console.log(`üì¶ Updating product ${r} to quantity ${a}`),this.updateCartItem(r,a,t,o).catch(s=>{console.error("‚ùå updateCartItem failed:",s),t.value=t.getAttribute("data-original-value")||"1"})}async updateCartItem(e,t,o,a){if(this.activeRequests.has(e)){console.log(`‚è≥ Request already in progress for product ${e}`);return}this.activeRequests.add(e),this.showLoadingOverlay(a);try{const n=a.getAttribute("data-update-url")||`/cart/update/${e}/`;console.log(`üîÑ Updating cart: URL=${n}, quantity=${t}`);const r=new FormData;r.append("quantity",t.toString()),r.append("csrfmiddlewaretoken",this.csrfToken);const s=await fetch(n,{method:"POST",body:r,headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP ${s.status}`);const i=await s.json();console.log("üì• Server response:",i),i.success?(await this.updateCartUI(i,e,o),this.showToast({message:"Cart updated successfully",type:"success"})):i.message&&this.showToast({message:i.message,type:"error"})}catch(n){console.error("‚ùå updateCartItem failed:",n),this.showToast({message:"Error updating cart",type:"error"}),o.value=o.getAttribute("data-original-value")||"1"}finally{this.hideLoadingOverlay(a),this.activeRequests.delete(e)}}async updateCartUI(e,t,o){const a=document.getElementById(`total-${t}`);if(a){const n=this.parsePrice(a.textContent||"0"),r=parseFloat(e.item_total);await this.animateNumber(a,n,r,this.currencySymbol)}await this.updateCartTotals(e.cart_total_price),this.updateCartCount(e.cart_total_items),o.max=e.product_stock.toString(),o.value=e.item_quantity.toString(),o.setAttribute("data-original-value",e.item_quantity.toString())}async updateCartTotals(e){const t=document.getElementById("cart-subtotal"),o=document.getElementById("cart-total"),a=document.getElementById("sticky-cart-total"),n=parseFloat(e);for(const r of[t,o,a])if(r){const s=this.parsePrice(r.textContent||"0");await this.animateNumber(r,s,n,this.currencySymbol)}}animateNumber(e,t,o,a="",n=""){return new Promise(r=>{const i=performance.now(),d=o-t,l=m=>{const h=m-i,u=Math.min(h/300,1),y=1-Math.pow(1-u,3),g=t+d*y;e.textContent=`${a}${this.formatNumber(Math.round(g))}${n}`,u<1?requestAnimationFrame(l):r()};requestAnimationFrame(l)})}parsePrice(e){return parseFloat(e.replace(/[^0-9.-]+/g,""))||0}formatNumber(e){return e.toLocaleString("en-US")}updateCartCount(e){const t=document.querySelector(".cart-item-count");if(t){const o=e===1?"item":"items";t.textContent=`${e} ${o}`}}async handleRemoveItem(e){e.preventDefault();const t=e.currentTarget,o=t.closest(".cart-card");if(!(!t.action.split("/").filter(Boolean).pop()||!o)){this.showLoadingOverlay(o);try{const r=await(await fetch(t.action,{method:"POST",body:new FormData(t),headers:{"X-Requested-With":"XMLHttpRequest"}})).json();r.success&&(await this.removeCartItemRow(o,r),this.showToast({message:"Item removed from cart",type:"success"}))}catch{this.showToast({message:"Error removing item",type:"error"})}finally{this.hideLoadingOverlay(o)}}}async removeCartItemRow(e,t){e.classList.add("removing"),await new Promise(o=>setTimeout(o,400)),e.remove(),await this.updateCartTotals(t.cart_total_price),this.updateCartCount(t.cart_total_items),t.cart_total_items===0&&location.reload()}showToast(e){const{message:t,type:o,duration:a=3e3}=e;if(!this.toastContainer)return;const n=document.createElement("div");n.className=`toast toast-${o}`,n.setAttribute("role",o==="error"?"alert":"status"),n.innerHTML=`
            <div class="toast-icon">${this.getToastIcon(o)}</div>
            <div class="toast-message">${t}</div>
        `,this.toastContainer.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),n.classList.add("hide"),setTimeout(()=>n.remove(),300)},a)}getToastIcon(e){const t={success:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/></svg>`,error:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>`,warning:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/></svg>`};return t[e]||t.success}showLoadingOverlay(e){if(e.querySelector(".loading-overlay"))return;const t=document.createElement("div");t.className="loading-overlay",t.innerHTML='<div class="loading-spinner"><div class="spinner"></div></div>',e.appendChild(t)}hideLoadingOverlay(e){const t=e.querySelector(".loading-overlay");t&&t.remove()}showStockWarningDynamic(e,t){const o=e.querySelector(".quantity-control");if(!o||o.querySelector(".stock-warning-dynamic"))return;const a=document.createElement("div");a.className="stock-warning-dynamic",a.innerHTML=`
            <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
                <path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="1.2"/></svg>
            Only ${t} available
        `,o.appendChild(a)}hideStockWarningDynamic(e){const t=e.querySelector(".stock-warning-dynamic");t&&t.remove()}}document.addEventListener("DOMContentLoaded",()=>{try{window.cartManager=new p}catch(c){console.error("üí• Failed to initialize CartManager:",c)}});
