function E(){const i=document.getElementById("priceRange"),e=document.getElementById("priceDisplay");if(i&&e){const t=()=>{const n=parseInt(i.value,10).toLocaleString();e.textContent=`${n} KES`};t(),i._priceDisplayAdded||(i.addEventListener("input",t),i._priceDisplayAdded=!0,console.log("Price range listener added."))}C(),A()}function C(){document.querySelectorAll("#resultsRoot .product-card").forEach(e=>{e.addEventListener("mouseenter",()=>{e.classList.add("hover"),N(e)}),e.addEventListener("mouseleave",()=>{e.classList.remove("hover")}),R(e)})}function N(i){const e=i.getAttribute("data-hover-image");if(e&&!i.classList.contains("image-preloaded")){const t=new Image;t.src=e,t.onload=()=>{i.classList.add("image-preloaded")}}}function R(i){const e=i.querySelectorAll("img[data-src]"),t=new IntersectionObserver(n=>{n.forEach(s=>{if(s.isIntersecting){const o=s.target,a=o.getAttribute("data-src");a&&(o.src=a,o.removeAttribute("data-src"),t.unobserve(o),o.addEventListener("load",()=>{o.classList.add("loaded")}))}})},{rootMargin:"50px 0px",threshold:.01});e.forEach(n=>t.observe(n))}function A(){const i=document.querySelectorAll("#resultsRoot .product-card"),e=new IntersectionObserver(t=>{t.forEach(n=>{if(n.isIntersecting){const s=n.target,o=s.getAttribute("data-product-id");o&&!s.classList.contains("view-tracked")&&(s.classList.add("view-tracked"),document.dispatchEvent(new CustomEvent("analytics:productView",{detail:{productId:parseInt(o),list:P(),position:Array.from(i).indexOf(s)+1}})))}})},{threshold:.5});i.forEach(t=>e.observe(t))}function P(){return document.body.classList.contains("search-page")?"search":document.body.classList.contains("category-page")?"category":window.location.pathname.includes("/deals/")?"deals":"general"}function D(){const i=document.querySelector("[name=csrfmiddlewaretoken]");return i?i.value:""}function y(i,e){if(typeof window.showNotification=="function"){window.showNotification(i,e);return}const t=document.createElement("div");t.className=`toast ${e}`;const n=document.createElement("i");n.className=e==="success"?"fas fa-check-circle":"fas fa-exclamation-circle",t.appendChild(n),t.appendChild(document.createTextNode(i)),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutDown 0.3s ease forwards",t.addEventListener("animationend",()=>t.remove())},2700)}function B(){const i=document.getElementById("main-product-image"),e=document.querySelectorAll(".thumbnail-item"),t=document.getElementById("image-zoom-container"),n=document.getElementById("fullscreen-btn");if(!i||!t)return;e.forEach(r=>{const l=r.querySelector(".thumbnail-image");l&&r.addEventListener("click",f=>{f.preventDefault();const h=l.dataset.src||l.src,p=l.dataset.largeSrc||h;i.style.opacity="0",setTimeout(()=>{i.src=h,i.dataset.largeSrc=p,t.style.backgroundImage=`url(${p})`,i.style.opacity="1"},200),e.forEach(g=>g.classList.remove("active")),r.classList.add("active")})});const s=i.parentElement;s&&(s.addEventListener("mousemove",r=>{const{left:l,top:f,width:h,height:p}=s.getBoundingClientRect(),g=(r.clientX-l)/h*100,m=(r.clientY-f)/p*100;t.style.backgroundPosition=`${g}% ${m}%`}),s.addEventListener("mouseenter",()=>{t.classList.add("active")}),s.addEventListener("mouseleave",()=>{t.classList.remove("active")})),n?.addEventListener("click",()=>{const r=z(i.dataset.largeSrc||i.src);document.body.appendChild(r)});let o=0,a=0;i.addEventListener("touchstart",r=>{o=r.changedTouches[0].screenX}),i.addEventListener("touchend",r=>{a=r.changedTouches[0].screenX,d()});function d(){a<o-50?c(1):a>o+50&&c(-1)}function c(r){const f=(Array.from(e).findIndex(h=>h.classList.contains("active"))+r+e.length)%e.length;e[f].click()}i.style.transition="opacity 0.3s ease"}function z(i){const e=document.createElement("div");e.className="image-lightbox",e.style.cssText=`
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95); display: flex; align-items: center;
    justify-content: center; z-index: 9999; cursor: zoom-out;
    animation: fadeIn 0.3s ease;
  `;const t=document.createElement("img");t.src=i,t.style.cssText=`
    max-width: 90%; max-height: 90%; object-fit: contain;
    animation: zoomIn 0.3s ease;
  `;const n=document.createElement("button");n.innerHTML='<i class="fas fa-times"></i>',n.style.cssText=`
    position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.9);
    border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem;
    cursor: pointer; color: #1e293b; transition: all 0.3s ease;
  `,n.addEventListener("mouseover",()=>{n.style.background="#ffffff",n.style.transform="rotate(90deg) scale(1.1)"}),n.addEventListener("mouseout",()=>{n.style.transform="rotate(0) scale(1)"});const s=()=>{e.style.animation="fadeOut 0.3s ease",setTimeout(()=>e.remove(),300)};n.addEventListener("click",s),e.addEventListener("click",d=>{d.target===e&&s()});const o=d=>{d.key==="Escape"&&(s(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),e.appendChild(t),e.appendChild(n);const a=document.createElement("style");return a.textContent=`
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  `,document.head.appendChild(a),e}function O(){const i=document.querySelector(".rating-input");if(!i)return;const e=i.querySelectorAll("label"),t=i.querySelectorAll('input[type="radio"]');e.forEach((n,s)=>{n.addEventListener("click",()=>{t[s].checked=!0}),n.addEventListener("mouseenter",()=>{const o=5-s;e.forEach((a,d)=>{a.style.color=5-d<=o?"#fbbf24":"#cbd5e1"})}),n.addEventListener("mouseleave",()=>{e.forEach((o,a)=>{const d=t[a].checked;o.style.color=d?"#f59e0b":"#cbd5e1"})})})}function $(){const i=document.querySelector(".quantity-input"),e=document.querySelector(".quantity-minus"),t=document.querySelector(".quantity-plus");if(!i)return;let n=parseInt(i.dataset.maxStock||"99");new MutationObserver(o=>{o.forEach(a=>{a.type==="attributes"&&a.attributeName==="data-max-stock"&&(n=parseInt(i.dataset.maxStock||"99"),i.max=n.toString())})}).observe(i,{attributes:!0}),e?.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(i.value)||1;a>1&&(i.value=(a-1).toString(),S(e))}),t?.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(i.value)||1;a<n&&(i.value=(a+1).toString(),S(t))}),i.addEventListener("input",()=>{let o=parseInt(i.value)||1;o<1&&(o=1),o>n&&(o=n),i.value=o.toString()}),i.addEventListener("keydown",o=>{o.key==="ArrowUp"?(o.preventDefault(),t?.click()):o.key==="ArrowDown"&&(o.preventDefault(),e?.click())})}function S(i){i.style.transform="scale(0.9)",setTimeout(()=>{i.style.transform="scale(1)"},150)}function F(){const i=document.querySelector("[data-product-variants]");if(!i)return;const e=JSON.parse(i.dataset.productVariants||"[]");if(e.length===0)return;const t=document.querySelectorAll(".color-pill"),n=document.querySelectorAll(".size-pill"),s=document.getElementById("product-price"),o=document.getElementById("product-original-price"),a=document.getElementById("product-stock-status"),d=document.querySelector('input[name="variant_id"]'),c=document.getElementById("selected-color"),r=document.getElementById("selected-size"),l=document.getElementById("add-to-cart-button"),f=document.querySelector(".quantity-input");t.forEach(p=>{p.addEventListener("click",function(){t.forEach(g=>g.classList.remove("active")),this.classList.add("active"),c&&(c.value=this.dataset.color||""),h()})}),n.forEach(p=>{p.addEventListener("click",function(){n.forEach(g=>g.classList.remove("active")),this.classList.add("active"),r&&(r.value=this.dataset.size||""),h()})});function h(){const p=c?.value||null,g=r?.value||null,m=e.find(v=>{const q=!v.color||v.color===p||!p,x=!v.size||v.size===g||!g;return q&&x});m&&s&&a&&d&&l&&f&&(s.style.opacity="0.5",setTimeout(()=>{s.textContent=`KES ${m.price.toLocaleString()}`,s.style.opacity="1"},150),o&&(o.style.display="none"),m.quantity>10?a.innerHTML='<span class="stock-in"><i class="fas fa-check-circle"></i> In Stock</span>':m.quantity>0?a.innerHTML=`<span class="stock-low"><i class="fas fa-exclamation-circle"></i> Only ${m.quantity} left!</span>`:a.innerHTML='<span class="stock-out"><i class="fas fa-times-circle"></i> Out of Stock</span>',d.value=m.id.toString(),l.disabled=m.quantity<=0,f.max=m.quantity.toString(),f.dataset.maxStock=m.quantity.toString(),parseInt(f.value)>m.quantity&&(f.value=m.quantity>0?m.quantity.toString():"1"))}}function H(){const i=document.getElementById("toggle-review-form"),e=document.getElementById("review-form");!i||!e||i.addEventListener("click",t=>{t.preventDefault();const n=e.classList.toggle("active");i.innerHTML=n?'<i class="fas fa-times"></i> Cancel':'<i class="fas fa-edit"></i> Write a Review',n&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},400)})}function X(){const i=document.getElementById("review-filter"),e=document.getElementById("review-sort"),t=document.querySelector(".reviews-list");if(!t)return;function n(){const s=i?.value??"all",o=e?.value??"newest",a=Array.from(t.querySelectorAll(".review-item"));a.forEach(c=>{const r=c.dataset.rating??"",l=s==="all"||r===s;c.style.display=l?"block":"none",l?c.style.animation="fadeIn 0.3s ease":c.style.animation=""});const d=a.filter(c=>c.style.display!=="none");d.sort((c,r)=>{const l=new Date(c.dataset.date??"").getTime(),f=new Date(r.dataset.date??"").getTime(),h=parseInt(c.dataset.rating??"0",10),p=parseInt(r.dataset.rating??"0",10),g=parseInt(c.dataset.helpful??"0",10),m=parseInt(r.dataset.helpful??"0",10);switch(o){case"newest":return f-l;case"oldest":return l-f;case"highest":return p-h;case"lowest":return h-p;case"most_helpful":return m-g;default:return 0}}),d.forEach(c=>t.appendChild(c))}i?.addEventListener("change",n),e?.addEventListener("change",n),n(),j(),U()}function j(){document.querySelectorAll(".helpful-btn").forEach(e=>{const t=e.dataset.reviewId,n=e.dataset.url;if(!t||!n)return;e.dataset.voted==="true"&&e.classList.add("voted"),e.addEventListener("click",async o=>{if(o.preventDefault(),e.dataset.busy==="true")return;e.dataset.busy="true",e.disabled=!0;const a=e.querySelector(".helpful-count"),d=e.closest(".review-item");try{const c=await fetch(n,{method:"POST",headers:{"X-CSRFToken":D(),"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},credentials:"same-origin"});if(c.status===401||c.status===403){y("You need to log in to vote helpful reviews.","error");return}if(!c.ok){y("Could not register vote. Please try again.","error");return}const r=await c.json();if(r.success){const l=typeof r.new_count<"u"?parseInt(r.new_count,10):null;l!==null&&a&&(a.textContent=`(${l})`),d&&l!==null&&(d.dataset.helpful=String(l)),r.voted?(e.classList.add("voted"),e.dataset.voted="true",y("Marked as helpful","success")):r.unvoted&&(e.classList.remove("voted"),e.dataset.voted="false",y("Removed helpful vote","success")),e.style.transform="scale(1.05)",setTimeout(()=>e.style.transform="scale(1)",180)}else y(r.message||"Unable to vote","error")}catch(c){console.error("Helpful vote error",c),y("An error occurred. Please try again.","error")}finally{e.disabled=!1,e.dataset.busy="false"}})})}function U(){document.querySelectorAll(".delete-review-btn").forEach(i=>{const e=i.dataset.reviewId;e&&i.addEventListener("click",async t=>{if(t.preventDefault(),!!confirm("Delete your review? This cannot be undone.")){i.disabled=!0;try{const s=await fetch(`/reviews/${e}/delete/`,{method:"POST",headers:{"X-CSRFToken":D(),"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},credentials:"same-origin"});if(!s.ok){y("Could not delete review. Please try again.","error");return}const o=await s.json();if(o.success){const a=i.closest(".review-item");a&&a.remove(),y("Review deleted","success")}else y(o.message||"Unable to delete review","error")}catch(s){console.error("Delete review error",s),y("Network error. Try again later.","error")}finally{i.disabled=!1}}})})}function W(){const i=document.querySelector(".mobile-sticky-cta"),e=document.querySelector(".add-to-cart-form");if(!i||!e)return;new IntersectionObserver(n=>{n.forEach(s=>{i.style.transform=s.isIntersecting?"translateY(100%)":"translateY(0)"})},{threshold:.1}).observe(e),i.style.transition="transform 0.3s ease"}let L=!1;function V(){if(L){console.warn("[Init] Product detail already initialized ‚Äì skipping duplicate");return}L=!0,B(),$(),F(),O(),X(),H(),W(),console.log("‚úÖ Product detail page initialized")}function I(){console.log("Initializing search page enhancements..."),M()}function M(){const i=document.getElementById("priceRange"),e=document.getElementById("priceDisplay");if(i&&e){const t=()=>{const n=parseInt(i.value,10).toLocaleString();e.textContent=`${n} KES`};t(),i._priceDisplayAdded||(i.addEventListener("input",t),i._priceDisplayAdded=!0,console.log("Search page price range listener added."))}}function b(){console.log("Initializing categories page enhancements..."),K()}function K(){const i=document.getElementById("priceRange"),e=document.getElementById("priceDisplay");if(i&&e){const t=()=>{const n=parseInt(i.value,10).toLocaleString();e.textContent=`${n} KES`};t(),i._priceDisplayAdded||(i.addEventListener("input",t),i._priceDisplayAdded=!0,console.log("Categories page price range listener added."))}}class w{static updateQueryStringParameter(e,t,n){const s=new URL(e,window.location.origin);return s.searchParams.set(t,n),s.toString()}static removeQueryStringParameter(e,t){const n=new URL(e,window.location.origin);return n.searchParams.delete(t),n.toString()}static getQueryStringParameter(e,t){return new URL(e,window.location.origin).searchParams.get(t)}static buildQueryString(e){const t=new URLSearchParams;return Object.entries(e).forEach(([n,s])=>{s!=null&&s!==""&&t.append(n,String(s))}),t.toString()}static debounce(e,t,n=!1){let s;return(...o)=>{const a=()=>{s=void 0,n||e.apply(this,o)},d=n&&!s;clearTimeout(s),s=window.setTimeout(a,t),d&&e.apply(this,o)}}static throttle(e,t){let n;return(...s)=>{n||(e.apply(this,s),n=!0,setTimeout(()=>n=!1,t))}}static formatPrice(e,t="KES"){return new Intl.NumberFormat("en-KE",{style:"currency",currency:t,minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}static formatNumber(e){return new Intl.NumberFormat("en-KE").format(e)}static formatDate(e,t={}){const n={year:"numeric",month:"short",day:"numeric",...t};return new Intl.DateTimeFormat("en-KE",n).format(new Date(e))}static setStorage(e,t,n){try{const s={value:t,timestamp:n?Date.now()+n*60*1e3:null};localStorage.setItem(e,JSON.stringify(s))}catch(s){console.warn("Local storage not available:",s)}}static getStorage(e){try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return n.timestamp&&Date.now()>n.timestamp?(localStorage.removeItem(e),null):n.value}catch(t){return console.warn("Error reading from storage:",t),null}}static removeStorage(e){try{localStorage.removeItem(e)}catch(t){console.warn("Error removing from storage:",t)}}static getCSRFToken(){const e=document.querySelector("[name=csrfmiddlewaretoken]");return e?e.value:""}static async apiRequest(e,t={}){const n={headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken(),...t.headers}};try{const s=await fetch(e,{...n,...t}),o=await s.json();if(!s.ok)throw new Error(o.error||"Request failed");return o}catch(s){return console.error("API request failed:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}static createElement(e,t={},n=[]){const s=document.createElement(e);return Object.entries(t).forEach(([o,a])=>{o==="className"?s.className=a:s.setAttribute(o,a)}),n.forEach(o=>{typeof o=="string"?s.appendChild(document.createTextNode(o)):s.appendChild(o)}),s}static animateElement(e,t,n=300){return new Promise(s=>{e.style.animation=`${t} ${n}ms`,setTimeout(()=>{e.style.animation="",s()},n)})}static validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static validatePhone(e){return/^\+?[\d\s-()]{10,}$/.test(e)}static measurePerformance(e,t){const n=performance.now(),s=e(),o=performance.now();return console.log(`${t} took ${o-n}ms`),s}}class u{static instance;cartCountElements;cartLink;wishlist=new Set;static lastNotificationTime=0;static notificationDebounceMs=300;static isNotifying=!1;constructor(){this.cartCountElements=document.querySelectorAll(".cart-count, #cart-count, #mobile-cart-count"),this.cartLink=document.getElementById("cart-link"),this.loadWishlist(),this.bindEvents(),console.log("üõí CartManager initialized")}static getInstance(){return u.instance||(u.instance=new u),u.instance}bindEvents(){const e=this._cartUpdateListener;e&&(document.body.removeEventListener("htmx:afterRequest",e),console.log("üßπ Removed existing HTMX listener"));const t=this.handleCartUpdate.bind(this);this._cartUpdateListener=t,document.body.addEventListener("htmx:afterRequest",t),console.log("‚úÖ Cart HTMX listener registered"),document.addEventListener("wishlist:toggle",(n=>{this.toggleWishlist(n.detail.product)}))}handleCartUpdate(e){const t=e;if(t.target.closest(".add-to-cart-form")&&t.detail&&t.detail.xhr.status===200){console.log("üîî Cart update detected");try{const o=JSON.parse(t.detail.xhr.responseText);o.success?(this.updateCartCount(o.cart_total_items),this.showDebouncedNotification(o.message,"success"),this.dispatchCartEvent("add",o.cart_item)):o.message==="Product is already in your cart"?this.showDebouncedNotification(o.message,"warning"):this.showDebouncedNotification(o.message,"error")}catch(o){console.error("Error parsing cart response:",o,t.detail.xhr.responseText),this.showDebouncedNotification("An error occurred while updating cart.","error")}}}showDebouncedNotification(e,t){const n=Date.now();if(console.log("üì¨ Notification requested:",{message:e,type:t,timeSinceLastNotification:n-u.lastNotificationTime,isCurrentlyNotifying:u.isNotifying,willShow:!u.isNotifying&&n-u.lastNotificationTime>=u.notificationDebounceMs}),u.isNotifying){console.log("‚è≠Ô∏è  Notification skipped: Already showing a notification");return}if(n-u.lastNotificationTime<u.notificationDebounceMs){console.log("‚è≠Ô∏è  Notification debounced:",e);return}u.isNotifying=!0,u.lastNotificationTime=n,showNotification(e,t),console.log("‚úÖ Notification shown:",e),setTimeout(()=>{u.isNotifying=!1,console.log("üîì Notification system unlocked")},100)}updateCartCount(e){this.cartCountElements.forEach(t=>{t.textContent=e.toString(),t.classList.add("pulse"),setTimeout(()=>t.classList.remove("pulse"),300)}),this.cartLink&&(this.cartLink.style.transform="scale(1.2)",setTimeout(()=>{this.cartLink&&(this.cartLink.style.transform="scale(1)")},300))}toggleWishlist(e){this.wishlist.has(e.id)?(this.wishlist.delete(e.id),this.showDebouncedNotification("Removed from wishlist","info")):(this.wishlist.add(e.id),this.showDebouncedNotification("Added to wishlist","success")),this.saveWishlist(),this.updateWishlistUI(),document.dispatchEvent(new CustomEvent("wishlist:updated",{detail:{product:e,action:this.wishlist.has(e.id)?"add":"remove"}}))}isInWishlist(e){return this.wishlist.has(e)}loadWishlist(){const e=w.getStorage("wishlist");e&&(this.wishlist=new Set(e))}saveWishlist(){w.setStorage("wishlist",Array.from(this.wishlist))}updateWishlistUI(){document.querySelectorAll(".wishlist-btn").forEach(e=>{const t=parseInt(e.getAttribute("data-product-id")||"0");this.wishlist.has(t)?(e.classList.add("active"),e.innerHTML='<i class="fas fa-heart"></i>'):(e.classList.remove("active"),e.innerHTML='<i class="far fa-heart"></i>')})}dispatchCartEvent(e,t){const n=new CustomEvent("analytics:cart",{detail:{type:"cart_interaction",data:{action:e,item:t,timestamp:Date.now()}}});document.dispatchEvent(n)}quickAdd(e,t=1){const n=new FormData;n.append("product_id",e.toString()),n.append("quantity",t.toString()),n.append("csrfmiddlewaretoken",w.getCSRFToken()),fetch("/cart/add/",{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(s=>s.json()).then(s=>{s.success?(this.updateCartCount(s.cart_total_items),this.showDebouncedNotification(s.message,"success")):this.showDebouncedNotification(s.message,"error")}).catch(s=>{console.error("Quick add failed:",s),this.showDebouncedNotification("Failed to add item to cart","error")})}}u.getInstance();console.log("‚úÖ base.ts loaded - CartManager singleton created");console.log("üü¢ STORE main.ts loaded");let k=!1;function T(){if(k){console.warn("‚ö†Ô∏è Store already initialized, skipping...");return}const i=document.body.dataset.page;console.log(`üõí Store main script loaded. Page: ${i}`),i==="product-detail"?(console.log("üìù Detected product detail page"),V()):i==="product-list"?(console.log("üì¶ Detected product list page"),E()):i==="search"?(console.log("üîç Detected search page"),I()):i==="categories"&&(console.log("üìÇ Detected categories page"),b()),k=!0,document.body.addEventListener("htmx:afterSwap",e=>{const t=e.detail?.target;!t||t.id!=="resultsRoot"||(console.log(`‚Üª HTMX afterSwap on resultsRoot ‚Äì re-init page: ${i}`),i==="product-list"?E():i==="search"?I():i==="categories"&&b())})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T();
