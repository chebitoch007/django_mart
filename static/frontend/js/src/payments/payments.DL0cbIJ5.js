class j{memoryStore=new Map;useSessionStorage=!1;constructor(){try{const e="__storage_test__";sessionStorage.setItem(e,"test"),sessionStorage.removeItem(e),this.useSessionStorage=!0}catch{console.warn("[Storage] sessionStorage not available, using in-memory fallback"),this.useSessionStorage=!1}}setItem(e,t){try{this.useSessionStorage?sessionStorage.setItem(e,t):this.memoryStore.set(e,t)}catch(s){console.error("[Storage] Failed to set item:",s),this.memoryStore.set(e,t)}}getItem(e){try{return this.useSessionStorage?sessionStorage.getItem(e):this.memoryStore.get(e)||null}catch(t){return console.error("[Storage] Failed to get item:",t),this.memoryStore.get(e)||null}}removeItem(e){try{this.useSessionStorage&&sessionStorage.removeItem(e),this.memoryStore.delete(e)}catch(t){console.error("[Storage] Failed to remove item:",t),this.memoryStore.delete(e)}}clear(){try{this.useSessionStorage&&sessionStorage.clear(),this.memoryStore.clear()}catch(e){console.error("[Storage] Failed to clear storage:",e),this.memoryStore.clear()}}}const d=new j;function R(n){if(!n)return!1;const e=n.trim().replace(/\s+/g,""),t=/^(?:254|\+254|0)?(7[0-9]{8})$/,s=e.match(t);return s?`254${s[1]}`:!1}function F(n){return n?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.trim()):!1}function L(n,e){const t=e==="UGX"||e==="TZS"?0:2;return n.toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t})}function G(n){try{d.setItem("paymentFormState",JSON.stringify(n))}catch(e){console.warn("[Storage] Failed to save form state:",e)}}function W(){try{const n=d.getItem("paymentFormState");return n?JSON.parse(n):{}}catch(n){return console.warn("[Storage] Failed to restore form state:",n),{}}}async function q(n,e={},t=3e4){const s=new AbortController,a=setTimeout(()=>s.abort(),t);try{const i=await fetch(n,{...e,signal:s.signal});return clearTimeout(a),i}catch(i){throw clearTimeout(a),i.name==="AbortError"?new Error("Request timed out. Please check your connection."):i}}function J(n){return{mpesa:"M-Pesa",paypal:"PayPal",paystack:"Paystack"}[n]||n}function x(n){return["USD","EUR","GBP","CAD","AUD","JPY","CHF","HKD","SGD","SEK","DKK","PLN","NOK","HUF","CZK","ILS","MXN","NZD","BRL","PHP","TWD","THB","TRY","RUB","CNY","INR","MYR"].includes(n.toUpperCase())}function Y(n){return["NGN","GHS","ZAR","USD","KES"].includes(n.toUpperCase())}const K={mpesa:[{title:"Connecting to M-Pesa",text:"Establishing secure connection with Safaricom..."},{title:"Sending Payment Request",text:"Your phone will receive a payment prompt shortly..."},{title:"Awaiting Confirmation",text:"Please check your phone and enter your M-Pesa PIN to complete the payment..."},{title:"Verifying Payment",text:"Confirming your payment with M-Pesa..."},{title:"Finalizing Transaction",text:"Processing payment confirmation and updating your order..."}],paypal:[{title:"Connecting to PayPal",text:"Establishing secure connection..."},{title:"Processing Payment",text:"Completing your PayPal transaction..."},{title:"Finalizing Order",text:"Confirming payment and updating your order..."}],paystack:[{title:"Initializing Payment",text:"Setting up secure payment with Paystack..."},{title:"Processing Transaction",text:"Verifying your payment details..."},{title:"Confirming Payment",text:"Finalizing your transaction..."},{title:"Updating Order",text:"Completing your purchase..."}]};function V(n,e,t){e.forEach(s=>{s.classList.toggle("active",s.dataset.method===n)}),t.textContent=J(n)}function Z(n,e,t){const a={mpesa:{text:"Pay with M-Pesa",icon:"fas fa-mobile-alt"},paypal:{text:"Pay with PayPal",icon:"fab fa-paypal"},paystack:{text:"Pay with Paystack",icon:"fas fa-credit-card"}}[n];e.textContent=a.text,t.className=a.icon}function Q(n,e,t,s){n==="paypal"&&!x(e)?(s.textContent=`Don't worry! PayPal doesn't support ${e}, but we'll automatically convert your payment to USD at the current exchange rate.`,t.style.display="flex"):n==="paystack"&&!Y(e)?(s.textContent=`Don't worry! Paystack doesn't support ${e}, but we'll automatically convert your payment to a supported currency at the current exchange rate.`,t.style.display="flex"):X(t)}function X(n){n.style.display="none"}function A(n,e,t,s){e.classList.add("active");let a=0;function i(){const l=K[n]||K.mpesa;if(a<l.length){const r=l[a];t.textContent=r.title,s.textContent=r.text,a++,a<l.length&&setTimeout(i,2e3)}}i()}function y(n){n.classList.remove("active")}function m(n,e,t=!0){const s=e.querySelector("span");s&&(s.textContent=n),e.style.display=t?"flex":"none"}function N(n,e){const t=document.getElementById("paypal-status");if(!t)return;const s=t.querySelector("span");s&&(s.textContent=n),t.className=`payment-status ${e}`,t.style.display="flex"}function D(n){const e=document.getElementById("paypal-status");if(!e)return;const t=e.querySelector("span");t&&(t.textContent=n),e.className="payment-status error",e.style.display="flex"}function U(){const n=document.getElementById("paypal-status");if(!n)return;n.style.display="none";const e=n.querySelector("span");e&&(e.textContent="")}function k(n,e,t){n.classList.add("input-error"),n.classList.remove("input-success");const s=e.querySelector("span");s?s.textContent=t:e.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${t}`,e.classList.add("show")}function T(n,e){n.classList.remove("input-error"),n.classList.add("input-success"),e.classList.remove("show")}function p(n,e){n?(e.classList.add("loading"),e.disabled=!0):(e.classList.remove("loading"),e.disabled=!1)}function w(n,e){const t=document.getElementById("paystack-status");if(!t)return;const s=t.querySelector("span");s&&(s.textContent=n),t.className=`payment-status ${e}`,t.style.display="flex"}function ee(){const n=document.getElementById("paystack-status");if(!n)return;n.style.display="none";const e=n.querySelector("span");e&&(e.textContent="")}class v{static instance;paymentInProgress=!1;currentReference=null;constructor(){}static getInstance(){return v.instance||(v.instance=new v),v.instance}getCurrentReference(){return this.currentReference}setCurrentReference(e){this.currentReference=e}isPaymentInProgress(){return this.paymentInProgress}setPaymentInProgress(e){this.paymentInProgress=e}reset(){this.paymentInProgress=!1,this.currentReference=null,d.removeItem("lastPaystackReference")}}const C=v.getInstance();async function te(n){const e=n.getState(),t=n.getElements(),s=n.getConfig();console.log("[PAYSTACK] üöÄ Initialization started (Standard Redirect Flow)"),ee();const a=t.paymentErrors.querySelector("span");a&&(a.textContent=""),t.paymentErrors.style.display="none";const i=t.paystackEmailInput;if(!i)return console.error("[PAYSTACK] ‚ùå Email input element not found"),m("Email input not found. Please refresh the page.",t.paymentErrors),!1;const l=i.value.trim();if(!l)return console.warn("[PAYSTACK] ‚ö†Ô∏è Email is empty"),k(i,t.paystackEmailError,"A valid email address is required for Paystack payment."),i.focus(),!1;if(!F(l))return console.warn("[PAYSTACK] ‚ö†Ô∏è Email format invalid:",l),k(i,t.paystackEmailError,"Please enter a valid email address."),i.focus(),!1;console.log("[PAYSTACK] ‚úÖ Email validated:",l),p(!0,t.paymentSubmitButton),w("Initializing secure payment...","info"),console.log("[PAYSTACK] üì° Sending initialization request to:",s.urls.initializePaystack);try{const r=await q(s.urls.initializePaystack,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s.csrfToken},body:JSON.stringify({order_id:s.orderId,amount:e.currentConvertedAmount,currency:e.currentCurrency,email:l})}),o=await r.json();if(r.ok&&o.success&&o.authorization_url){console.log("[PAYSTACK] ‚úÖ Backend initialization successful. Redirecting..."),w("Redirecting to secure payment page...","success"),o.reference&&(C.setCurrentReference(o.reference),d.setItem("lastPaystackReference",o.reference));const c=d.getItem("paymentFormState"),u=c?JSON.parse(c):{};return u.email=l,d.setItem("paymentFormState",JSON.stringify(u)),setTimeout(()=>{window.location.href=o.authorization_url},500),new Promise(()=>{})}else{const c=o.error||o.error_message||o.message||"Failed to initialize Paystack payment.";return m(c,t.paymentErrors),p(!1,t.paymentSubmitButton),C.reset(),!1}}catch(r){console.error("[PAYSTACK] Initialization error:",r);const o=r instanceof Error?r.message:"Network error during payment initialization.";return m(o,t.paymentErrors),p(!1,t.paymentSubmitButton),C.reset(),!1}}async function H(n,e,t=0){const a=e.getElements(),i=e.getConfig();console.log(`[PAYSTACK] Verifying payment: ${n} (Attempt ${t+1}/20)`),a.processingModal.classList.contains("active")||A("paystack",a.processingModal,a.modalTitle,a.modalText),p(!0,a.paymentSubmitButton);try{const r=await(await q(i.urls.paystackStatus,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":i.csrfToken},body:JSON.stringify({reference:n})})).json();if(r.status==="completed"&&r.order_id)console.log("[PAYSTACK] ‚úÖ Payment completed!"),y(a.processingModal),w("Payment verified! Redirecting...","success"),C.reset(),d.removeItem("paymentFormState"),d.removeItem("lastCheckoutRequestId"),d.removeItem("lastPaystackReference"),setTimeout(()=>{window.location.href=i.urls.orderSuccess.replace(i.orderId,r.order_id)},1500);else if(r.status==="failed")console.log("[PAYSTACK] ‚ùå Payment failed"),y(a.processingModal),p(!1,a.paymentSubmitButton),C.reset(),m(r.message||"Payment verification failed. Please try again.",a.paymentErrors);else if(r.status==="pending"||r.status==="processing")t>=20?(console.warn("[PAYSTACK] ‚è±Ô∏è Polling timeout. Payment still processing."),y(a.processingModal),p(!1,a.paymentSubmitButton),C.reset(),m("Payment is still processing. We will update your order once confirmed. Please check your order history or contact support if this persists.",a.paymentErrors)):(console.log("[PAYSTACK] ‚è≥ Payment still processing, polling again..."),setTimeout(()=>H(n,e,t+1),3e3));else{console.error("[PAYSTACK] ‚ùì Unknown status:",r.status),y(a.processingModal),p(!1,a.paymentSubmitButton),C.reset();const o=r.message||"Unable to verify payment status. Please contact support.";m(o,a.paymentErrors)}}catch(l){console.error("[PAYSTACK] Verification error:",l),y(a.processingModal),p(!1,a.paymentSubmitButton),C.reset();const r=l instanceof Error?l.message:"Network error verifying payment.";m(r,a.paymentErrors)}}function ne(){C.reset(),console.info("[PAYSTACK] Payment state reset")}function se(n){const e=d.getItem("lastPaystackReference");if(e){console.warn("[PAYSTACK] Found existing payment reference:",e);const t=n.getElements();w("Resuming previous payment session...","info"),n.setState({currentMethod:"paystack"}),A("paystack",t.processingModal,t.modalTitle,t.modalText),setTimeout(()=>{H(e,n,0)},1e3)}}class b{static instance;paymentInProgress=!1;finalizationInProgress=!1;activePoller=null;currentCheckoutRequestId=null;constructor(){}static getInstance(){return b.instance||(b.instance=new b),b.instance}isPaymentInProgress(){return this.paymentInProgress||this.finalizationInProgress}startPayment(e){this.paymentInProgress=!0,this.currentCheckoutRequestId=e}startFinalization(){return this.finalizationInProgress?(console.warn("[MPESA] Finalization already in progress"),!1):(this.finalizationInProgress=!0,!0)}reset(){this.paymentInProgress=!1,this.finalizationInProgress=!1,this.currentCheckoutRequestId=null,this.activePoller!==null&&(clearInterval(this.activePoller),this.activePoller=null)}setPoller(e){this.activePoller=e}clearPoller(){this.activePoller!==null&&(clearInterval(this.activePoller),this.activePoller=null)}}const h=b.getInstance();async function ae(n){if(h.isPaymentInProgress())return console.warn("[MPESA] Payment already in progress"),!1;try{const e=n.getState(),t=n.getElements(),s=n.getConfig(),a=t.phoneInput.value.trim(),i=R(a);if(!i)return m("Please enter a valid phone number",t.paymentErrors),!1;p(!0,t.paymentSubmitButton),A("mpesa",t.processingModal,t.modalTitle,t.modalText);const l={order_id:s.orderId,provider:"MPESA",phone:i,amount:e.currentConvertedAmount,currency:e.currentCurrency},r=await q(s.urls.initiatePayment,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(l)},3e4),o=await r.json();if(!r.ok||!o.success||!o.checkout_request_id)return y(t.processingModal),p(!1,t.paymentSubmitButton),m(o?.error||"Failed to initiate M-Pesa payment",t.paymentErrors),!1;h.startPayment(o.checkout_request_id),n.setState({lastCheckoutRequestId:o.checkout_request_id});const c=document.getElementById("checkoutRequestId");return c&&(c.value=o.checkout_request_id),d.setItem("lastCheckoutRequestId",o.checkout_request_id),t.modalTitle.textContent="Payment Sent to Phone",t.modalText.textContent="Please check your phone and approve the M-Pesa prompt.",re(o.checkout_request_id,n),!0}catch(e){console.error("[MPESA] Error:",e),y(n.getElements().processingModal),p(!1,n.getElements().paymentSubmitButton),h.reset();const t=e instanceof Error?e.message:"Network error. Please try again.";return m(t,n.getElements().paymentErrors),!1}}function re(n,e){const t=e.getElements(),s=e.getConfig();h.clearPoller();const a=3e3,i=40;let l=0;const r=window.setInterval(async()=>{if(l++,l>i){h.clearPoller(),y(t.processingModal),p(!1,t.paymentSubmitButton),h.reset(),m("Payment timed out. Please try again.",t.paymentErrors);return}try{const o=new URL(s.urls.mpesaStatus,window.location.origin);o.searchParams.set("checkout_request_id",n);const c=await fetch(o.toString(),{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!c.ok)throw new Error(`HTTP ${c.status}`);const u=await c.json();u.status==="success"||u.status==="completed"?(h.clearPoller(),t.modalTitle.textContent="Payment Confirmed!",t.modalText.textContent="Finalizing your order...",oe(n,e)):(u.status==="failed"||u.status==="cancelled")&&(h.clearPoller(),y(t.processingModal),p(!1,t.paymentSubmitButton),h.reset(),m(u.message||"Payment failed",t.paymentErrors))}catch(o){console.error("[MPESA] polling error",o)}},a);h.setPoller(r)}function oe(n,e){if(!h.startFinalization())return;const t=e.getElements(),s=e.getConfig(),a=e.getState(),i=new FormData;i.append("csrfmiddlewaretoken",s.csrfToken),i.append("order_id",s.orderId),i.append("payment_method","mpesa"),i.append("checkout_request_id",n),i.append("phone_number",t.phoneInput.value.trim()),i.append("amount",a.currentConvertedAmount.toString()),i.append("currency",a.currentCurrency),i.append("conversion_rate",a.currentRate.toString()),fetch(s.urls.processPayment,{method:"POST",headers:{"X-CSRFToken":s.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:i}).then(async l=>{const r=await l.json();if(r.success||r.status==="success"||r.message?.includes("already"))d.removeItem("lastCheckoutRequestId"),d.removeItem("paymentFormState"),h.reset(),t.modalTitle.textContent="Payment Successful!",t.modalText.textContent="Redirecting...",setTimeout(()=>{y(t.processingModal),window.location.href=r.redirect_url||s.urls.orderSuccess},1500);else throw new Error(r.message||"Payment verification failed")}).catch(l=>{console.error("[MPESA] finalize error:",l),y(t.processingModal),p(!1,t.paymentSubmitButton),h.reset(),m(l.message||"Error finalizing payment",t.paymentErrors)})}function ie(){h.reset(),console.info("[MPESA] Payment state reset")}let P=null,E=!1;function $(n){if(E){console.log("[PayPal] Already initializing, skipping...");return}const e=n.getState();if(e.paypalInitialized&&P){console.log("[PayPal] Already initialized, skipping...");return}E=!0,U();const t=n.getElements(),s=n.getConfig(),a=document.getElementById("paypal-button-container");if(P){try{P.close()}catch(i){console.warn("[PayPal] Error closing existing buttons:",i)}P=null}a&&(a.innerHTML="");try{if(typeof window.paypal>"u"){console.error("[PayPal] SDK not loaded");const r=document.getElementById("paypal-fallback");r&&(r.style.display="block"),E=!1;return}let i=e.currentCurrency,l=e.currentConvertedAmount;if(!x(e.currentCurrency)){i="USD";const r=Array.from(t.currencySelector.options).find(o=>o.value==="USD");if(r){const o=parseFloat(r.dataset.rate||"1");l=parseFloat(s.cartTotalPrice)*o}N(`Converting to USD ${L(l,"USD")} for PayPal`,"info")}if(console.log("[PayPal] Initializing with:",{amount:l,currency:i}),P=window.paypal.Buttons({onInit:function(r,o){console.log("[PayPal] onInit called");const c=()=>{const u=t.termsCheckbox?.checked||!1;console.log("[PayPal] Terms checked:",u),u?o.enable():o.disable()};if(t.termsCheckbox){const u=t.termsCheckbox,g=u.checked,f=u.cloneNode(!0);f.checked=g,u.parentNode?.replaceChild(f,u),t.termsCheckbox=f,t.termsCheckbox.addEventListener("change",c),console.log("[PayPal] Terms checkbox listener attached")}c()},onClick:function(r,o){return console.log("[PayPal] Button clicked"),t.termsCheckbox.checked?(U(),o.resolve()):(D("You must agree to the terms and conditions"),o.reject())},createOrder:function(r,o){const c=n.getState();let u=c.currentCurrency,g=c.currentConvertedAmount;if(!x(c.currentCurrency)){u="USD";const f=Array.from(t.currencySelector.options).find(I=>I.value==="USD");if(f){const I=parseFloat(f.dataset.rate||"1");g=parseFloat(s.cartTotalPrice)*I}}return console.log("[PayPal] Creating order:",{amount:g.toFixed(2),currency:u,orderId:s.orderId}),o.order.create({purchase_units:[{amount:{value:g.toFixed(2),currency_code:u},description:`Order #${s.orderId}`,custom_id:s.orderId}]})},onApprove:function(r,o){return console.log("[PayPal] Payment approved, capturing..."),n.setState({paypalProcessing:!0}),A("paypal",t.processingModal,t.modalTitle,t.modalText),o.order.capture().then(function(c){console.log("[PayPal] Payment captured:",c);const u=document.getElementById("paypalOrderId"),g=document.getElementById("paypalPayerId");u&&(u.value=r.orderID),g&&(g.value=c.payer.payer_id);const f=n.getState();let I=f.currentCurrency,M=f.currentConvertedAmount,B=1;if(!x(f.currentCurrency)){I="USD";const z=Array.from(t.currencySelector.options).find(_=>_.value==="USD");z&&(B=parseFloat(z.dataset.rate||"1"),M=parseFloat(s.cartTotalPrice)*B)}const S=new FormData;S.append("csrfmiddlewaretoken",s.csrfToken),S.append("order_id",s.orderId),S.append("payment_method","paypal"),S.append("paypal_order_id",r.orderID),S.append("paypal_payer_id",c.payer.payer_id),S.append("amount",M.toFixed(2)),S.append("currency",I),S.append("conversion_rate",B.toString()),le(S,n)}).catch(function(c){console.error("[PayPal] Capture error:",c),y(t.processingModal),m("Failed to complete PayPal payment. Please try again.",t.paymentErrors),n.setState({paypalProcessing:!1})})},onError:function(r){console.error("[PayPal] Error:",r),D("PayPal payment failed. Please try another method."),n.setState({paypalProcessing:!1}),E=!1},onCancel:function(r){console.log("[PayPal] Payment canceled by user"),n.setState({paypalProcessing:!1}),N("Payment canceled","info")}}),P&&P.isEligible())P.render("#paypal-button-container").then(()=>{console.log("[PayPal] Buttons rendered successfully"),n.setState({paypalInitialized:!0});const r=document.getElementById("paypal-fallback");r&&(r.style.display="none"),E=!1}).catch(r=>{console.error("[PayPal] Error rendering buttons:",r);const o=document.getElementById("paypal-fallback");o&&(o.style.display="block"),n.setState({paypalInitialized:!1}),E=!1});else{console.warn("[PayPal] Buttons not eligible");const r=document.getElementById("paypal-fallback");r&&(r.style.display="block"),E=!1}}catch(i){console.error("[PayPal] Initialization error:",i);const l=document.getElementById("paypal-fallback");l&&(l.style.display="block"),n.setState({paypalInitialized:!1}),E=!1}}function O(){if(console.log("[PayPal] Cleaning up..."),P){try{P.close()}catch(e){console.warn("[PayPal] Error closing buttons:",e)}P=null}const n=document.getElementById("paypal-button-container");n&&(n.innerHTML=""),E=!1,console.log("[PayPal] Cleanup complete")}function le(n,e){const t=e.getElements(),s=e.getConfig();fetch(s.urls.processPayment,{method:"POST",body:n,headers:{"X-CSRFToken":s.csrfToken,"X-Requested-With":"XMLHttpRequest"}}).then(a).catch(i);function a(l){return l.ok?l.json().then(r=>{r.success||r.status==="success"?(d.removeItem("paymentFormState"),d.removeItem("lastCheckoutRequestId"),d.removeItem("lastPaystackReference"),t.modalTitle.textContent="Payment Successful!",t.modalText.textContent="Redirecting you to your order confirmation...",e.setState({paypalProcessing:!1}),setTimeout(()=>{y(t.processingModal),window.location.href=r.redirect_url||s.urls.orderSuccess},1500)):(y(t.processingModal),m(r.error_message||r.message||"Payment failed",t.paymentErrors),p(!1,t.paymentSubmitButton),e.setState({paypalProcessing:!1}))}):Promise.reject(l)}function i(l){console.error("[PayPal] Payment finalization error:",l),y(t.processingModal),p(!1,t.paymentSubmitButton),e.setState({paypalProcessing:!1}),l.json?l.json().then(r=>{m(r.error_message||r.message||"Unexpected error occurred",t.paymentErrors)}).catch(()=>{m("Network error. Please check your connection.",t.paymentErrors)}):m("Network error. Please check your connection.",t.paymentErrors)}}class ce{config;state;elements;isTransitioning=!1;originalTermsCheckbox=null;constructor(e){this.config=e;const t=e.cartTotalPrice.toString().replace(/,/g,""),s=parseFloat(t);console.log("[PaymentSystem] üîß Initializing with:",{rawInput:e.cartTotalPrice,parsedAmount:s,defaultCurrency:e.defaultCurrency}),this.state={currentMethod:"mpesa",currentCurrency:e.defaultCurrency,currentRate:1,currentConvertedAmount:s,paypalInitialized:!1,paypalProcessing:!1,processingStage:0},this.elements={},this.cacheElements(),this.originalTermsCheckbox=this.elements.termsCheckbox,this.addEventListeners(),this.restoreState(),this.updatePaymentMethod(this.state.currentMethod),this.updateAmounts(),se(this)}cacheElements(){const e=document.getElementById("paymentForm");if(!e){console.error("Payment form element not found.");return}this.elements={paymentForm:e,processingModal:document.getElementById("processingModal"),modalTitle:document.getElementById("modalTitle"),modalText:document.getElementById("modalText"),paymentStatus:document.getElementById("payment-status"),paystackStatus:document.getElementById("paystack-status"),paymentErrors:document.getElementById("paymentErrors"),selectedMethodInput:document.getElementById("selectedMethod"),currencySelector:document.getElementById("currencySelector"),currencyTooltip:document.getElementById("currencyTooltip"),tooltipText:document.getElementById("tooltipText"),methodConfirmation:document.getElementById("methodConfirmation"),selectedMethodName:document.getElementById("selectedMethodName"),paymentSubmitButton:document.getElementById("paymentSubmitButton"),submitText:document.getElementById("submitText"),submitIcon:document.getElementById("submitIcon"),formCurrency:document.getElementById("formCurrency"),formConversionRate:document.getElementById("formConversionRate"),formAmount:document.getElementById("formAmount"),mobileMoneySection:document.getElementById("mpesaSection"),paystackSection:document.getElementById("paystackSection"),paypalSection:document.getElementById("paypalSection"),paymentTabs:document.querySelectorAll(".payment-tabs .payment-tab"),phoneInput:document.getElementById("phoneNumber"),phoneError:document.getElementById("phoneError"),termsCheckbox:document.getElementById("termsAgreement"),summaryToggle:document.getElementById("summaryToggle"),summaryContent:document.getElementById("summaryContent"),paystackEmailInput:document.getElementById("paystackEmail"),paystackEmailError:document.getElementById("paystackEmailError")}}addEventListeners(){this.elements.paymentTabs.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-method");this.updatePaymentMethod(t)})}),this.elements.currencySelector.addEventListener("change",()=>this.updateAmounts()),this.elements.currencySelector.addEventListener("mouseover",()=>{Q(this.state.currentMethod,this.state.currentCurrency,this.elements.currencyTooltip,this.elements.tooltipText)}),this.elements.currencySelector.addEventListener("mouseout",()=>{X(this.elements.currencyTooltip)}),this.elements.paymentForm.addEventListener("submit",e=>this.handleFormSubmit(e)),this.elements.summaryToggle.addEventListener("click",()=>this.toggleSummary()),this.elements.phoneInput&&(this.elements.phoneInput.addEventListener("input",()=>{T(this.elements.phoneInput,this.elements.phoneError)}),this.elements.phoneInput.addEventListener("blur",()=>{this.state.currentMethod==="mpesa"&&this.elements.phoneInput.value.trim()&&(R(this.elements.phoneInput.value.trim())||k(this.elements.phoneInput,this.elements.phoneError,"Please enter a valid M-Pesa phone number (e.g., 712345678)"))})),this.elements.paystackEmailInput&&(this.elements.paystackEmailInput.addEventListener("input",()=>{T(this.elements.paystackEmailInput,this.elements.paystackEmailError)}),this.elements.paystackEmailInput.addEventListener("blur",()=>{this.state.currentMethod==="paystack"&&this.elements.paystackEmailInput.value.trim()&&(F(this.elements.paystackEmailInput.value.trim())||k(this.elements.paystackEmailInput,this.elements.paystackEmailError,"Please enter a valid email address"))})),this.initializeSummaryState()}restoreState(){const e=W();e.method&&(this.state.currentMethod=e.method),e.currency&&this.elements.currencySelector.querySelector(`option[value="${e.currency}"]`)&&(this.state.currentCurrency=e.currency,this.elements.currencySelector.value=e.currency),e.phone&&this.elements.phoneInput&&(this.elements.phoneInput.value=e.phone),e.email&&this.elements.paystackEmailInput&&(this.elements.paystackEmailInput.value=e.email),typeof e.terms=="boolean"&&this.elements.termsCheckbox&&(this.elements.termsCheckbox.checked=e.terms)}saveState(){const e=this.originalTermsCheckbox?this.originalTermsCheckbox.checked:this.elements.termsCheckbox?.checked;G({method:this.state.currentMethod,currency:this.state.currentCurrency,phone:this.elements.phoneInput?this.elements.phoneInput.value:void 0,email:this.elements.paystackEmailInput?this.elements.paystackEmailInput.value:void 0,terms:e})}enforceProviderCurrency(e){const t=this.elements.currencySelector.value;let s=t;e==="mpesa"&&t!=="KES"&&this.elements.currencySelector.querySelector('option[value="KES"]')&&(s="KES",console.log("[PaymentSystem] üí± Auto-switching to KES for M-Pesa")),e==="paypal"&&t==="KES"&&(this.elements.currencySelector.querySelector('option[value="USD"]')?s="USD":this.elements.currencySelector.querySelector('option[value="EUR"]')&&(s="EUR"),s!=="KES"&&console.log(`[PaymentSystem] üí± Auto-switching to ${s} for PayPal`)),e==="paystack"&&(Y(t)||(console.log(`[PaymentSystem] ‚ö†Ô∏è ${t} not supported by Paystack.`),this.elements.currencySelector.querySelector('option[value="KES"]')?s="KES":this.elements.currencySelector.querySelector(`option[value="${this.config.defaultCurrency}"]`)&&(s=this.config.defaultCurrency))),s!==t&&(this.elements.currencySelector.value=s,this.elements.currencyTooltip&&this.elements.tooltipText&&(this.elements.tooltipText.innerHTML=`<i class="fas fa-info-circle"></i> Switched to <b>${s}</b> for ${e} compatibility`,this.elements.currencyTooltip.style.display="flex",this.elements.currencyTooltip.classList.add("active"),setTimeout(()=>{this.elements.currencyTooltip.style.display="none",this.elements.currencyTooltip.classList.remove("active")},4e3)),this.updateAmounts())}updatePaymentMethod(e){if(this.isTransitioning)return;if(console.log(`[PaymentSystem] üîÄ updatePaymentMethod called: ${this.state.currentMethod} ‚Üí ${e}`),this.state.currentMethod===e&&this.state.processingStage===0){this.enforceProviderCurrency(e);return}this.isTransitioning=!0;const t=this.elements.termsCheckbox?this.elements.termsCheckbox.checked:!1;this.state.currentMethod==="mpesa"&&ie(),this.state.currentMethod==="paypal"&&(O(),this.state.paypalInitialized=!1),this.state.currentMethod==="paystack"&&ne(),this.state.currentMethod=e,this.elements.selectedMethodInput.value=e,this.state.processingStage=0;const s=this.elements.paymentErrors.querySelector("span");if(s&&(s.textContent=""),this.elements.paymentErrors.style.display="none",this.elements.mobileMoneySection.classList.remove("active"),this.elements.paypalSection.classList.remove("active"),this.elements.paystackSection.classList.remove("active"),e==="mpesa"?this.elements.mobileMoneySection.classList.add("active"):e==="paypal"?this.elements.paypalSection.classList.add("active"):e==="paystack"&&this.elements.paystackSection.classList.add("active"),e==="paypal"?this.elements.paymentSubmitButton.style.display="none":this.elements.paymentSubmitButton.style.display="block",V(e,this.elements.paymentTabs,this.elements.selectedMethodName),Z(e,this.elements.submitText,this.elements.submitIcon),this.elements.termsCheckbox&&(this.elements.termsCheckbox.checked=t),this.enforceProviderCurrency(e),e==="paypal"){const a=document.getElementById("paypal-status");a&&(a.style.display="none"),setTimeout(()=>{$(this),this.isTransitioning=!1},100)}else{if(e==="paystack"){const a=document.getElementById("paystack-status");a&&(a.style.display="none")}this.isTransitioning=!1}this.saveState()}updateAmounts(){const e=this.elements.currencySelector,t=e.options[e.selectedIndex],s=t.value,a=parseFloat(t.getAttribute("data-rate")||"1"),i=parseFloat(this.config.cartTotalPrice.toString().replace(/,/g,""));console.log("[PaymentSystem] üí± Calculation:",{base:i,rate:a,target:s}),this.state.currentCurrency=s,this.state.currentRate=a,this.state.currentConvertedAmount=i*a;const l=this.config.currencySymbols[s]||s;this.elements.formCurrency.value=s,this.elements.formConversionRate.value=a.toString(),this.elements.formAmount.value=this.state.currentConvertedAmount.toFixed(2);const r=`${l} ${L(this.state.currentConvertedAmount,s)}`,o=document.getElementById("amount");o&&(o.value=r);const c=document.getElementById("paystackAmount");c&&(c.value=r),document.querySelectorAll(".currency-symbol").forEach(I=>{I.textContent=l});const u=L(this.state.currentConvertedAmount,s),g=document.querySelector(".subtotal-amount"),f=document.querySelector(".total-amount");g&&(g.textContent=u),f&&(f.textContent=u),this.state.currentMethod==="paypal"&&this.state.paypalInitialized&&(console.log("[PaymentSystem] üîÑ Currency changed, re-initializing PayPal..."),O(),this.state.paypalInitialized=!1,setTimeout(()=>{$(this)},100)),this.saveState()}validateForm(){let e=!0;m("",this.elements.paymentErrors,!1);const t=this.originalTermsCheckbox||this.elements.termsCheckbox;if(!t||!t.checked)return m("You must agree to the Terms of Service",this.elements.paymentErrors),!1;if(this.state.currentMethod==="mpesa"){const s=this.elements.phoneInput.value.trim(),a=R(s);a?(this.elements.phoneInput.value=a,T(this.elements.phoneInput,this.elements.phoneError)):(k(this.elements.phoneInput,this.elements.phoneError,"Please enter a valid M-Pesa phone number (e.g., 712345678)"),e=!1)}if(this.state.currentMethod==="paystack"){const s=this.elements.paystackEmailInput.value.trim();!s||!F(s)?(k(this.elements.paystackEmailInput,this.elements.paystackEmailError,"Please enter a valid email address"),e=!1):T(this.elements.paystackEmailInput,this.elements.paystackEmailError)}return this.state.currentMethod==="paypal"?!0:e}async handleFormSubmit(e){if(e.preventDefault(),!this.validateForm())return;const t=this.state.currentMethod;t==="mpesa"?await ae(this):t==="paystack"?await te(this):t==="paypal"&&console.warn("PayPal form submitted directly - should use PayPal buttons")}toggleSummary(){this.elements.summaryContent.classList.toggle("collapsed"),this.elements.summaryToggle.classList.toggle("collapsed");const e=this.elements.summaryToggle.querySelector("span"),t=this.elements.summaryToggle.querySelector("i");e&&(e.textContent=this.elements.summaryContent.classList.contains("collapsed")?"Show Details":"Hide Details"),t&&(t.classList.toggle("fa-chevron-down"),t.classList.toggle("fa-chevron-up"))}initializeSummaryState(){if(window.innerWidth<=991){this.elements.summaryContent.classList.add("collapsed"),this.elements.summaryToggle.classList.add("collapsed");const e=this.elements.summaryToggle.querySelector("i");e&&(e.classList.remove("fa-chevron-down"),e.classList.add("fa-chevron-up"))}}getState(){return{...this.state}}setState(e){this.state={...this.state,...e}}getElements(){return{...this.elements}}getConfig(){return{...this.config}}getOriginalTermsCheckbox(){return this.originalTermsCheckbox}}document.addEventListener("DOMContentLoaded",function(){if(typeof window.paymentConfig>"u"){console.error("paymentConfig missing. Make sure checkout template injects it.");return}const n=window.paymentConfig,e={USD:"$",EUR:"‚Ç¨",GBP:"¬£",KES:"KSh",UGX:"USh",TZS:"TSh",NGN:"‚Ç¶",GHS:"GH‚Çµ"},t={cartTotalPrice:n.cartTotalPrice,defaultCurrency:n.defaultCurrency,csrfToken:n.csrfToken,currencySymbols:e,orderId:n.orderId,paypalClientId:n.paypalClientId,paystackPublicKey:n.paystackPublicKey,urls:n.urls,currencyOptions:Array.from(document.getElementById("currencySelector").querySelectorAll("option")).map(a=>({code:a.value,name:a.textContent.split(" - ")[1]||a.value,symbol:e[a.value]||a.value,rate:parseFloat(a.getAttribute("data-rate")||"1")}))};window.paymentSystem=new ce(t);const s=t.currencySymbols[t.defaultCurrency]||t.defaultCurrency;document.querySelectorAll(".currency-symbol").forEach(a=>{a.textContent=s})});
