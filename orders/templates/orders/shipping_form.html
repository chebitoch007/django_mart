


    {% load static crispy_forms_tags currency_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shipping Information | ASAI</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/shipping-form.css' %}">


  <style>
    .address-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .address-card:hover {
      border-color: #cbd5e1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .address-card.selected {
      border-color: #2563eb;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(67, 56, 202, 0.05));
    }

    .address-card .default-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .address-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2563eb, #4338ca);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
    }

    .new-address-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .new-address-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .save-address-section {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-left: 4px solid #2563eb;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>

</head>


<body class="bg-light">
  <div class="container py-4 py-md-5">

    <!-- Progress Indicator -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="progress-wrapper">
          <div class="progress-steps">
            <div class="step completed">
              <span class="step-number">1</span>
              <span class="step-label">Cart</span>
            </div>
            <div class="step active">
              <span class="step-number">2</span>
              <span class="step-label">Shipping</span>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <span class="step-label">Payment</span>
            </div>
            <div class="step">
              <span class="step-number">4</span>
              <span class="step-label">Confirmation</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ✅ ADDED: Currency display notice #}
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-info" role="alert" style="border-left: 4px solid #0284c7;">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Your selected currency:</strong> {{ user_currency }}
          <span class="ms-2 text-muted">|</span>
          <span class="ms-2">All prices are shown in {{ user_currency }}</span>
        </div>
      </div>
    </div>

    <!-- Main Form Card -->
    <div class="card form-card shadow-sm mx-auto">
      <div class="card-header form-card-header">
        <h1 class="h4 mb-0">
          <i class="fas fa-shipping-fast me-2"></i>
          Shipping Information
        </h1>
        <p class="mb-0 mt-1 text-white-50 small">
          Step 2 of 4: Choose delivery address
        </p>
      </div>

      <div class="card-body form-card-body">

        <!-- Messages -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {% for error in form.non_field_errors %}
              <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endif %}

        <form method="post" novalidate id="shipping-form">
          {% csrf_token %}

          <!-- Saved Addresses Section (if user has addresses) -->
          {% if has_addresses %}
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-bookmark me-2"></i>
              Saved Addresses
            </h5>
            <p class="text-muted small mb-3">Select a saved address or enter a new one below</p>

            <div id="saved-addresses-list">
              {% for address in saved_addresses %}
              <div class="address-card" data-address-id="{{ address.id }}" onclick="selectAddress({{ address.id }})">
                {% if address.is_default %}
                <span class="default-badge">
                  <i class="fas fa-star me-1"></i>Default
                </span>
                {% endif %}

                <div class="d-flex align-items-start">
                  <div class="address-card-icon">
                    <i class="fas fa-{% if address.address_type == 'home' %}home{% elif address.address_type == 'work' %}briefcase{% else %}map-marker-alt{% endif %}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1 fw-bold">
                      {{ address.nickname|default:address.get_address_type_display }}
                    </h6>
                    <p class="mb-1 text-muted small">
                      <strong>{{ address.full_name }}</strong>
                    </p>
                    <p class="mb-1 small">
                      {{ address.street_address }}<br>
                      {{ address.city }}, {{ address.state }} {{ address.postal_code }}<br>
                      {{ address.country.name }}
                    </p>
                    {% if address.phone %}
                    <p class="mb-0 small text-muted">
                      <i class="fas fa-phone me-1"></i>{{ address.phone }}
                    </p>
                    {% endif %}
                  </div>
                  <div class="form-check ms-2">
                    <input class="form-check-input" type="radio" name="saved_address"
                           value="{{ address.id }}" id="address-{{ address.id }}"
                           {% if address.is_default and not form.saved_address.value %}checked{% endif %}
                           {% if form.saved_address.value == address.id|stringformat:"s" %}checked{% endif %}>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Option to enter new address -->
            <div class="address-card" onclick="selectNewAddress()">
              <div class="d-flex align-items-center">
                <div class="address-card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                  <i class="fas fa-plus"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-bold">Use a different address</h6>
                  <p class="mb-0 small text-muted">Enter new shipping details</p>
                </div>
                <div class="form-check ms-2">
                  <input class="form-check-input" type="radio" name="saved_address"
                         value="" id="address-new">
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- New Address Form (shown when no saved addresses or "new address" selected) -->
          <div id="new-address-form" class="new-address-section {% if not has_addresses %}active{% endif %}">

            <!-- Personal Information -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="fas fa-user me-2"></i>
                Personal Information
              </h5>

              <div class="row g-3">
                <div class="col-md-6">
                  {{ form.first_name|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.last_name|as_crispy_field }}
                </div>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  {{ form.email|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.phone|as_crispy_field }}
                </div>
              </div>
            </div>

            <!-- Shipping Address -->
            <div class="form-section mt-4">
              <h5 class="section-title">
                <i class="fas fa-map-marked-alt me-2"></i>
                Shipping Address
              </h5>

              <div class="mb-3">
                {{ form.address|as_crispy_field }}
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  {{ form.city|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.postal_code|as_crispy_field }}
                </div>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  {{ form.state|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.country|as_crispy_field }}
                </div>
              </div>
            </div>

            <!-- Delivery Preferences -->
            <div class="form-section mt-4">
              <h5 class="section-title">
                <i class="fas fa-clipboard-list me-2"></i>
                Delivery Preferences
              </h5>

              <div class="mb-3">
                {{ form.delivery_instructions|as_crispy_field }}
              </div>

              <div class="form-check">
                {{ form.billing_same_as_shipping }}
                <label class="form-check-label" for="{{ form.billing_same_as_shipping.id_for_label }}">
                  {{ form.billing_same_as_shipping.label }}
                </label>
              </div>
            </div>

            <!-- Save Address Option (only for authenticated users) -->
            {% if user.is_authenticated %}
            <div class="save-address-section mt-4">
              <div class="form-check mb-3">
                {{ form.save_address }}
                <label class="form-check-label fw-medium" for="{{ form.save_address.id_for_label }}">
                  <i class="fas fa-save me-2"></i>
                  Save this address for future orders
                </label>
              </div>

              <div id="address-nickname-field" style="display: none;">
                {{ form.address_nickname|as_crispy_field }}
                <small class="text-muted">
                  <i class="fas fa-lightbulb me-1"></i>
                  Give it a memorable name like "Home", "Office", or "Parents' House"
                </small>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- ✅ ENHANCED: Order Summary with Currency-Aware Totals -->
          {% if cart %}
          <div class="order-summary mt-4 p-3 bg-light rounded">
            <h6 class="fw-bold mb-3">
              <i class="fas fa-shopping-cart me-2"></i>
              Order Summary
            </h6>
            <div class="d-flex justify-content-between mb-2">
              <span>Items in cart:</span>
              <span class="fw-semibold">{{ cart.items.count }}</span>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span class="fw-semibold">
                {% if cart_subtotal %}
                  {% display_money cart_subtotal.amount user_currency %}
                {% else %}
                  {# FIXED: Used as a tag, not a filter #}
                  {% convert_and_display cart.total_price %}
                {% endif %}
              </span>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span>Estimated Shipping:</span>
              <span class="fw-semibold">
                {% if cart_shipping %}
                  {% display_money cart_shipping.amount user_currency %}
                {% else %}
                   {% convert_and_display estimated_shipping %}
                {% endif %}
              </span>
            </div>
            <hr>

            <div class="d-flex justify-content-between">
              <span class="fw-bold">Estimated Total:</span>
              <span class="fw-bold text-primary">
                {% if cart_grand_total %}
                  {% display_money cart_grand_total.amount user_currency %}
                {% else %}
                  {# FIXED: Used as a tag, not a filter #}
                  {% convert_and_display cart.total_price %}
                {% endif %}
              </span>
            </div>

            <small class="text-muted d-block mt-2">
              <i class="fas fa-info-circle me-1"></i>
              All prices shown in {{ user_currency }}. Final total calculated on next page.
            </small>
          </div>
          {% endif %}

          <!-- Form Actions -->
          <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary btn-lg w-100" id="submit-btn">
              <i class="fas fa-arrow-right-circle me-2"></i>
              Proceed to Payment
            </button>

            <a href="{% url 'cart:cart_detail' %}" class="btn btn-outline-secondary btn-lg w-100 mt-3">
              <i class="fas fa-arrow-left me-2"></i>
              Back to Cart
            </a>
          </div>

          <!-- Security Note -->
          <div class="text-center mt-4">
            <small class="text-muted">
              <i class="fas fa-shield-check me-1"></i>
              Your information is secure and encrypted
            </small>
          </div>
        </form>
      </div>
    </div>

    <!-- Help Text -->
    <div class="text-center mt-4">
      <small class="text-muted">
        Need help? <a href="mailto:support@asai.co.ke">Contact Support</a>
      </small>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Enhanced address selection and form population script
// Add this to replace the existing script section in shipping_form.html

// Store address data as a JavaScript object
const savedAddressesData = {
  {% for address in saved_addresses %}
  {{ address.id }}: {
    full_name: "{{ address.full_name|escapejs }}",
    email: "{{ user.email|escapejs }}",
    phone: "{{ address.phone|escapejs }}",
    address: "{{ address.street_address|escapejs }}",
    city: "{{ address.city|escapejs }}",
    state: "{{ address.state|escapejs }}",
    postal_code: "{{ address.postal_code|escapejs }}",
    country: "{{ address.country.code|escapejs }}"
  },
  {% endfor %}
};

// Process addresses to split full_name into first_name and last_name
Object.keys(savedAddressesData).forEach(id => {
  const addr = savedAddressesData[id];
  const nameParts = addr.full_name.trim().split(/\s+/);
  addr.first_name = nameParts[0] || '';
  addr.last_name = nameParts.slice(1).join(' ') || '';
});

// Address selection logic
function selectAddress(addressId) {
  // Unselect all cards
  document.querySelectorAll('.address-card').forEach(card => {
    card.classList.remove('selected');
  });

  // Select clicked card
  const clickedCard = document.querySelector(`[data-address-id="${addressId}"]`);
  if (clickedCard) {
    clickedCard.classList.add('selected');
  }

  // Check the radio button
  const radioBtn = document.getElementById(`address-${addressId}`);
  if (radioBtn) {
    radioBtn.checked = true;
  }

  // Hide new address form
  document.getElementById('new-address-form').classList.remove('active');

  // Populate form fields with saved address data
  const addressData = savedAddressesData[addressId];
  if (addressData) {
    // Populate each field
    Object.keys(addressData).forEach(fieldName => {
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field) {
        if (field.tagName === 'SELECT') {
          // For select fields (like country)
          const option = field.querySelector(`option[value="${addressData[fieldName]}"]`);
          if (option) {
            field.value = addressData[fieldName];
          }
        } else {
          field.value = addressData[fieldName];
        }

        // Remove validation errors if they exist
        field.classList.remove('is-invalid');
        const errorDiv = field.closest('.mb-3')?.querySelector('.invalid-feedback');
        if (errorDiv) {
          errorDiv.remove();
        }
      }
    });
  }
}

function selectNewAddress() {
  // Unselect all cards
  document.querySelectorAll('.address-card').forEach(card => {
    card.classList.remove('selected');
  });

  // Select new address option
  const newAddressCard = document.querySelector('[onclick="selectNewAddress()"]');
  if (newAddressCard) {
    newAddressCard.classList.add('selected');
  }

  // Check the "new address" radio
  const newRadio = document.getElementById('address-new');
  if (newRadio) {
    newRadio.checked = true;
  }

  // Show new address form
  document.getElementById('new-address-form').classList.add('active');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Check if there's a default address selected
  const defaultRadio = document.querySelector('input[name="saved_address"]:checked');
  if (defaultRadio && defaultRadio.value) {
    // Populate form with default address
    selectAddress(defaultRadio.value);
  } else {
    // Show new address form if no saved addresses
    const hasAddresses = {{ has_addresses|lower }};
    if (!hasAddresses) {
      selectNewAddress();
    }
  }

  // Add click handlers to radio buttons
  document.querySelectorAll('input[name="saved_address"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === '') {
        selectNewAddress();
      } else {
        selectAddress(this.value);
      }
    });
  });
});

// Save address checkbox toggle
const saveAddressCheckbox = document.getElementById('{{ form.save_address.id_for_label }}');
const nicknameField = document.getElementById('address-nickname-field');

if (saveAddressCheckbox && nicknameField) {
  saveAddressCheckbox.addEventListener('change', function() {
    nicknameField.style.display = this.checked ? 'block' : 'none';
  });

  // Initial state
  if (saveAddressCheckbox.checked) {
    nicknameField.style.display = 'block';
  }
}

// Form submission
const form = document.getElementById('shipping-form');
const submitBtn = document.getElementById('submit-btn');

form.addEventListener('submit', function(e) {
  // Check if a saved address is selected
  const savedAddressRadio = document.querySelector('input[name="saved_address"]:checked');

  if (savedAddressRadio && savedAddressRadio.value && savedAddressRadio.value !== '') {
    // Ensure form fields are populated before submission
    const addressId = savedAddressRadio.value;
    const addressData = savedAddressesData[addressId];

    if (addressData) {
      Object.keys(addressData).forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field && !field.value) {
          field.value = addressData[fieldName];
        }
      });
    }
  }

  if (submitBtn.disabled) {
    e.preventDefault();
    return;
  }

  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
  submitBtn.disabled = true;

  setTimeout(() => {
    if (submitBtn.disabled) {
      submitBtn.innerHTML = '<i class="fas fa-arrow-right-circle me-2"></i>Proceed to Payment';
      submitBtn.disabled = false;
    }
  }, 5000);
});

// Phone number formatting
const phoneInput = document.querySelector('input[name="phone"]');
if (phoneInput) {
  phoneInput.addEventListener('blur', function() {
    let value = this.value.trim();
    if (value && !value.startsWith('+') && /^\d/.test(value)) {
      this.value = '+' + value;
    }
  });
}

// Character counter for delivery instructions
const deliveryTextarea = document.querySelector('textarea[name="delivery_instructions"]');
if (deliveryTextarea) {
  const maxLength = 200;
  const counterDiv = document.createElement('div');
  counterDiv.className = 'text-end text-muted small mt-1';
  counterDiv.id = 'char-counter';
  deliveryTextarea.parentNode.appendChild(counterDiv);

  function updateCounter() {
    const remaining = maxLength - deliveryTextarea.value.length;
    counterDiv.textContent = `${remaining} characters remaining`;
    counterDiv.style.color = remaining < 20 ? '#dc3545' : '#6c757d';
  }

  deliveryTextarea.addEventListener('input', updateCounter);
  updateCounter();
}

// Auto-dismiss success alerts
const alerts = document.querySelectorAll('.alert-success');
alerts.forEach(alert => {
  setTimeout(() => {
    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
    bsAlert.close();
  }, 5000);
});
  </script>
</body>
</html>