{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
        <!-- Header with Gradient Background -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 py-6 px-8">
            <div class="flex justify-between items-center flex-wrap">
                <div>
                    <h1 class="text-2xl font-bold text-white">
                        {% if form.instance.pk %}Edit Product{% else %}Add New Product{% endif %}
                    </h1>
                    <p class="text-blue-100">
                        {% if form.instance.pk %}
                            Update details for {{ form.instance.name }}
                        {% else %}
                            Fill out the form to add a new product
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-center px-3 py-1 bg-white/20 rounded-full text-sm text-white mt-2 sm:mt-0">
                    <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus-circle{% endif %} mr-2"></i>
                    <span>{% if form.instance.pk %}Editing Mode{% else %}Creation Mode{% endif %}</span>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="p-6" id="product-form">
            {% csrf_token %}

            <!-- Form Error Handling -->
            {% if form.errors %}
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">
                            Please correct the {{ form.errors|pluralize:"error,errors" }} below
                        </h3>
                        <div class="mt-2 text-sm text-red-700">
                            <ul class="list-disc pl-5 space-y-1">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Product Information -->
            <div class="bg-gray-50 p-6 rounded-xl mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i> Product Information
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Name -->
                    <div>
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Product Name *
                        </label>
                        {{ form.name }}
                        <p class="mt-1 text-sm text-gray-500">5-100 characters (letters, numbers, spaces, hyphens)</p>
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Category *
                        </label>
                        {{ form.category }}
                    </div>

                    <!-- Description -->
                    <div class="md:col-span-2">
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Full Description *
                        </label>
                        {{ form.description }}
                        <p class="mt-1 text-sm text-gray-500">Detailed product description</p>
                    </div>

                    <!-- Short Description -->
                    <div class="md:col-span-2">
                        <label for="{{ form.short_description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Short Description
                        </label>
                        {{ form.short_description }}
                        <p class="mt-1 text-sm text-gray-500">Brief description shown in product listings (max 300 characters)</p>
                    </div>
                </div>
            </div>

            <!-- Pricing & Inventory -->
            <div class="bg-gray-50 p-6 rounded-xl mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-tag mr-2 text-blue-500"></i> Pricing & Inventory
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Price -->
                    <div>
                        <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Price (KSh) *
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">KSh</span>
                            </div>
                            {{ form.price }}
                        </div>
                    </div>

                    <!-- Discount Price -->
                    <div>
                        <label for="{{ form.discount_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Discount Price (KSh)
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">KSh</span>
                            </div>
                            {{ form.discount_price }}
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Leave blank if no discount</p>
                    </div>

                    <!-- Stock -->
                    <div>
                        <label for="{{ form.stock.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Stock Quantity *
                        </label>
                        {{ form.stock }}
                    </div>
                </div>
            </div>

            <!-- Product Images -->
            <div class="bg-gray-50 p-6 rounded-xl mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-images mr-2 text-blue-500"></i> Product Images
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Main Image -->
                    <div>
                        <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Main Product Image *
                        </label>
                        {{ form.image }}
                        <p class="mt-1 text-sm text-gray-500">Primary image shown on product listings</p>

                        {% if form.instance.pk and form.instance.image %}
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Current Image:</h3>
                            <div class="w-40 h-40 border rounded-md overflow-hidden">
                                <img src="{{ form.instance.image.url }}" alt="Current product image" class="w-full h-full object-contain">
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Additional Images -->
                    <div>
                        <label for="id_additional_images" class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Images
                        </label>
                        <input type="file" name="additional_images" id="id_additional_images" multiple class="w-full px-3 py-2 border rounded-md">
                        <p class="mt-1 text-sm text-gray-500">Upload multiple images (JPG, PNG, max 5MB each)</p>

                        {% if form.instance.pk and form.instance.additional_images.exists %}
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Current Additional Images:</h3>
                            <div class="flex flex-wrap gap-4">
                                {% for image in form.instance.additional_images.all %}
                                <div class="flex flex-col items-center">
                                    <div class="w-20 h-20 border rounded-md overflow-hidden">
                                        <img src="{{ image.image.url }}" alt="Additional image" class="w-full h-full object-contain">
                                    </div>
                                    <div class="mt-2 flex items-center">
                                        <input type="checkbox" name="delete_images" value="{{ image.id }}" id="delete_image_{{ image.id }}" class="rounded text-blue-600">
                                        <label for="delete_image_{{ image.id }}" class="text-xs text-gray-700 ml-1">Delete</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Product Settings -->
            <div class="bg-gray-50 p-6 rounded-xl mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-cog mr-2 text-blue-500"></i> Product Settings
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Availability -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5 mt-1">
                            {{ form.available }}
                        </div>
                        <div class="ml-3">
                            <label for="{{ form.available.id_for_label }}" class="font-medium text-gray-700">
                                Product Available
                            </label>
                            <p class="text-gray-500 text-sm mt-1">Show this product in your store</p>
                        </div>
                    </div>

                    <!-- Featured -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5 mt-1">
                            {{ form.featured }}
                        </div>
                        <div class="ml-3">
                            <label for="{{ form.featured.id_for_label }}" class="font-medium text-gray-700">
                                Featured Product
                            </label>
                            <p class="text-gray-500 text-sm mt-1">Highlight on homepage</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <a href="{% url 'store:product_dashboard' %}" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    {% if form.instance.pk %}Update Product{% else %}Create Product{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Main image preview
    const mainImageInput = document.getElementById('id_image');
    if (mainImageInput) {
        mainImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const previewContainer = document.createElement('div');
                previewContainer.className = 'mt-4';
                previewContainer.innerHTML = `
                    <h3 class="text-sm font-medium text-gray-700 mb-2">New Image Preview:</h3>
                    <div class="w-40 h-40 border rounded-md overflow-hidden">
                        <img src="${URL.createObjectURL(file)}" alt="Preview" class="w-full h-full object-contain">
                    </div>
                `;

                // Remove existing preview if any
                const existingPreview = mainImageInput.parentElement.querySelector('.mt-4');
                if (existingPreview) {
                    existingPreview.remove();
                }

                mainImageInput.parentElement.appendChild(previewContainer);
            }
        });
    }

    // Additional images preview
    const additionalImagesInput = document.getElementById('id_additional_images');
    if (additionalImagesInput) {
        additionalImagesInput.addEventListener('change', function(event) {
            const files = event.target.files;

            // Clear previous preview container
            const existingPreview = additionalImagesInput.parentElement.querySelector('.mt-4');
            if (existingPreview) {
                existingPreview.remove();
            }

            if (files.length > 0) {
                const previewContainer = document.createElement('div');
                previewContainer.className = 'mt-4';
                previewContainer.innerHTML = `
                    <h3 class="text-sm font-medium text-gray-700 mb-2">New Images Preview:</h3>
                    <div class="flex flex-wrap gap-4" id="additional-images-preview"></div>
                `;
                additionalImagesInput.parentElement.appendChild(previewContainer);

                const previewDiv = document.getElementById('additional-images-preview');

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'flex flex-col items-center';
                        imgContainer.innerHTML = `
                            <div class="w-20 h-20 border rounded-md overflow-hidden">
                                <img src="${URL.createObjectURL(file)}" alt="Preview" class="w-full h-full object-contain">
                            </div>
                        `;
                        previewDiv.appendChild(imgContainer);
                    }
                }
            }
        });
    }

    // Form validation
    const form = document.getElementById('product-form');
    form.addEventListener('submit', function() {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <i class="fas fa-spinner fa-spin mr-2"></i>
            {% if form.instance.pk %}Updating...{% else %}Creating...{% endif %}
        `;
    });
});
</script>

<style>
.form-control {
    display: block;
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    background-color: white;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
}

.form-control:focus {
    border-color: #3b82f6;
    outline: 0;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
}

input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 0.25rem;
    border: 1px solid #d1d5db;
}

input[type="checkbox"]:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}
</style>
{% endblock %}