{% extends 'store/base.html' %}
{% load humanize %}
{% load static query_transform %}

{% block body_class %}product-list-page{% endblock %}
{% block page_name %}product-list{% endblock %}

{% block extra_head %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="product-list-container">
    <div class="product-list-header">
        <div>
            <h1 class="page-title">
                {% if category %}{{ category.name }}{% else %}Premium Gaming Accessories{% endif %}
            </h1>
            {% if category %}
            <p class="page-description">{{ category.description }}</p>
            {% else %}
            <p class="page-description">Explore our collection of high-performance gaming gear and accessories designed for competitive gamers</p>
            {% endif %}
        </div>
        <div class="product-count">{{ products.paginator.count }} Products</div>
    </div>

    <div class="product-list-layout">
        <aside class="filter-sidebar" aria-label="Filters">
            <button class="filter-toggle" id="filterToggle" aria-expanded="false" aria-controls="filterContent">
                <i class="fas fa-filter" aria-hidden="true"></i> <span id="filterToggleText">Show Filters</span>
            </button>

            <div class="filter-card" id="filterContent" hidden>
                <div class="filter-header">
                    <h2 class="filter-title">
                        <i class="fas fa-filter filter-icon" aria-hidden="true"></i> Filters
                    </h2>
                    <a href="?{% query_transform max_price=None in_stock=None page=None brand=None supplier=None min_rating=None %}" class="reset-link">Reset All</a>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-sort section-icon" aria-hidden="true"></i> Sort By</h3>
                    <div class="sort-options">
                        {% for sort_key, sort_name in sort_options.items %}
                        <a href="?{% query_transform sort=sort_key %}" class="sort-option {% if sort_by == sort_key %}active{% endif %}">
                            <span>{{ sort_name }}</span>
                            {% if sort_by == sort_key %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            {% else %}
                            <i class="fas fa-chevron-right" aria-hidden="true"></i>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-tag section-icon" aria-hidden="true"></i> Price Range</h3>
                    <div class="price-filter">
                        <input type="range" class="price-slider" min="0" max="1000" value="{{ max_price }}" id="priceRange" aria-label="Maximum price">
                        <div class="price-display">
                            <span>0 KES</span>
                            <span id="priceDisplay">{{ max_price }} KES</span>
                        </div>
                        <div class="price-inputs">
                            <input type="number" id="minPriceInput" class="price-input" placeholder="Min" min="0" max="100000">
                            <input type="number" id="maxPriceInput" class="price-input" placeholder="Max" min="0" max="100000" value="{{ max_price }}">
                            <button class="apply-price-btn" id="applyPriceBtn">Apply Price</button>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-star section-icon" aria-hidden="true"></i> Minimum Rating</h3>
                    <div class="rating-filter">
                        {% for i in "54321" %}
                            <a href="?{% query_transform min_rating=i %}" class="rating-option {% if min_rating == i %}active{% endif %}">{{ i }} & up</a>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-briefcase section-icon" aria-hidden="true"></i> Brands</h3>
                    <div class="brand-filter" role="list" style="max-height:220px;overflow:auto;">
                        {% for brand in brands %}
                        <a href="?{% query_transform brand=brand.slug page=None %}" class="brand-item" role="listitem" aria-label="Filter by {{ brand.name }}">
                            {% if brand.logo %}
                                <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo-small">
                            {% else %}
                                <span class="brand-name">{{ brand.name }}</span>
                            {% endif %}
                            <span class="brand-count" aria-hidden="true">{{ brand.product_count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-truck section-icon" aria-hidden="true"></i> Suppliers</h3>
                    <div class="supplier-filter" style="max-height:160px;overflow:auto;">
                        {% for sup in suppliers %}
                        <a href="?{% query_transform supplier=sup.id page=None %}" class="supplier-item">
                            <span class="supplier-name">{{ sup.name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="section-title"><i class="fas fa-box section-icon" aria-hidden="true"></i> Availability</h3>
                    <div class="stock-filter">
                        <input type="checkbox" id="inStock" class="stock-checkbox" {% if in_stock %}checked{% endif %}>
                        <label for="inStock" class="stock-label">In Stock Only</label>
                    </div>
                </div>
            </div>
        </aside>

        <main class="product-grid-container" id="resultsRoot">
            {% include 'store/product/_results_grid.html' %}
        </main>
    </div>

    <section class="brands-section">
        <h2 class="brands-title">Shop By Brand</h2>
        <div class="brands-grid">
            {% for brand in brands %}
                <a href="?{% query_transform brand=brand.slug page=None %}" class="brand-card">
                    {% if brand.logo %}
                    <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo">
                    {% else %}
                    <span class="brand-name">{{ brand.name }}</span>
                    {% endif %}
                </a>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // simple filter toggle for mobile
  const toggle = document.getElementById('filterToggle');
  const content = document.getElementById('filterContent');
  const toggleText = document.getElementById('filterToggleText');
  if (toggle && content) {
    toggle.addEventListener('click', () => {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      toggle.setAttribute('aria-expanded', String(!expanded));
      content.hidden = expanded;
      toggleText.textContent = expanded ? 'Show Filters' : 'Hide Filters';
    });
  }

  // price range -> update display and apply via query_transform link
  const priceRange = document.getElementById('priceRange');
  const priceDisplay = document.getElementById('priceDisplay');
  const applyBtn = document.getElementById('applyPriceBtn');
  const maxInput = document.getElementById('maxPriceInput');
  if (priceRange && priceDisplay) {
    priceRange.addEventListener('input', () => priceDisplay.textContent = priceRange.value + ' KES');
    if (maxInput) maxInput.value = priceRange.value;
  }
  if (applyBtn && maxInput) {
    applyBtn.addEventListener('click', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('max_price', String(maxInput.value || priceRange.value));
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  }

  // in-stock checkbox
  const inStock = document.getElementById('inStock');
  if (inStock) {
    inStock.addEventListener('change', function() {
      const url = new URL(window.location.href);
      if (this.checked) url.searchParams.set('in_stock', 'true');
      else url.searchParams.delete('in_stock');
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  }
});
</script>
{% endblock %}
