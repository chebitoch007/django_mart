{% extends 'store/base.html' %}
{% load humanize %}
{% load static query_transform %}

{% block body_class %}product-list-page{% endblock %}
{% block page_name %}product-list{% endblock %}

{% block extra_head %}
{{ block.super }}
{% endblock %}

{% block content %}
<div class="product-list-container">
    <div class="product-list-header">
        <div>
            <h1 class="page-title">
                {% if category %}{{ category.name }}{% else %}Premium Gaming Accessories{% endif %}
            </h1>
            {% if category %}
            <p class="page-description">{{ category.description }}</p>
            {% else %}
            <p class="page-description">Explore our collection of high-performance gaming gear and accessories designed
                for competitive gamers</p>
            {% endif %}
        </div>
        <div class="product-count">{{ products.paginator.count }} Products</div>
    </div>

    <div class="product-list-layout">

        <!-- Filter Sidebar -->
        <aside class="filter-sidebar" id="filterSidebar" aria-label="Filters">
            <!-- Toggle Button for Mobile -->
            <button class="filter-toggle" id="filterToggle" aria-expanded="false">
                <i class="fas fa-filter"></i> <span>Show Filters</span>
            </button>

            <!-- Filters Content -->
            <div class="filter-content" id="filterContent" hidden>
                <div class="filter-header">
                    <h2><i class="fas fa-sliders-h"></i> Filters</h2>
                    <a href="?{% query_transform max_price=None in_stock=None brand=None supplier=None min_rating=None %}"
                       class="reset-link">Reset</a>
                </div>

<!-- Sort -->
<div class="filter-section">
  <h3><i class="fas fa-sort section-icon"></i> Sort By</h3>
  <div class="sort-options">
    {% for key, opt in sort_options.items %}
      <a
        hx-get="?{% query_transform sort=key page=None %}"
        hx-target="#resultsRoot"
        hx-swap="innerHTML"
        hx-indicator="#grid-loading-spinner"
        class="sort-option {% if sort_by == key %}active{% endif %}"
      >
        <i class="fas {{ opt.icon }}"></i> {{ opt.label }}
      </a>
    {% endfor %}
  </div>
</div>


                <!-- Price -->
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="price-filter">
                        <input type="range"
                               min="0"
                               max="1000"
                               value="{{ max_price|default:500 }}"
                               id="priceRange"
                               class="price-slider">
                        <div class="price-display">
                            <span>0 KES</span>
                            <span id="priceDisplay">{{ max_price|default:"500" }} KES</span>
                        </div>
                        <button class="apply-price-btn"
                                hx-get="?{% query_transform page=None %}"
                                hx-include="#priceRange"
                                hx-vals='js:{max_price: document.getElementById("priceRange").value}'
                                hx-target="#resultsRoot"
                                hx-swap="innerHTML"
                                hx-indicator="#grid-loading-spinner"
                                id="applyPriceBtn">
                            Apply
                        </button>
                    </div>
                </div>

                <!-- Rating -->
                <div class="filter-section">
                    <h3>Minimum Rating</h3>
                    <div class="rating-filter">
                        {% for i in "54321" %}
                        <a hx-get="?{% query_transform min_rating=i page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="rating-option {% if min_rating == i %}active{% endif %}">
                            {{ i }}â˜… & up
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Brands -->
                <div class="filter-section">
                    <h3>Brands</h3>
                    <div class="brand-filter">
                        {% for brand in brands %}
                        <a hx-get="?{% query_transform brand=brand.slug page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="brand-item {% if selected_brand == brand.slug %}active{% endif %}">
                            {{ brand.name }}
                            <span class="count">({{ brand.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Suppliers -->
                <div class="filter-section">
                    <h3>Suppliers</h3>
                    <div class="supplier-filter">
                        {% for sup in suppliers %}
                        <a hx-get="?{% query_transform supplier=sup.id page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="supplier-item {% if selected_supplier == sup.id|stringformat:'s' %}active{% endif %}">
                            {{ sup.name }}
                            <span class="count">({{ sup.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- In Stock -->
                <div class="filter-section">
                    <label class="stock-filter">
                        <input type="checkbox"
                               id="inStock"
                               name="in_stock"
                               value="true"
                               hx-get="?{% query_transform page=None %}"
                               hx-vals='js:{in_stock: document.getElementById("inStock").checked ? "true" : "false"}'
                               hx-target="#resultsRoot"
                               hx-swap="innerHTML"
                               hx-trigger="change"
                               hx-indicator="#grid-loading-spinner"
                               {% if in_stock %}checked{% endif %}>
                        <span class="stock-label">In Stock Only</span>
                    </label>
                </div>
            </div>

<div class="sort-section">
  <h4>Sort By</h4>
  <form method="get" id="sortForm">
    <input type="hidden" name="q" value="{{ query }}">
    <select name="sort" onchange="this.form.submit()" class="sort-dropdown">
      {% for key, option in sort_options.items %}
        <option value="{{ key }}" {% if key == sort %}selected{% endif %}>
          <i class="fa {{ option.icon }}"></i> {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </form>
</div>

        </aside>

        <main class="product-grid-container">
            <!-- Loading Indicator -->
            <div id="grid-loading-spinner" class="htmx-indicator">
                <i class="fas fa-spinner fa-spin"></i>
            </div>

            <div id="resultsRoot">
                {% include 'store/product/_results_grid.html' %}
            </div>
        </main>
    </div>

    <section class="brands-section">
        <h2 class="brands-title">Shop By Brand</h2>
        <div class="brands-grid">
            {% for brand in brands %}
            <a href="?{% query_transform brand=brand.slug page=None %}" class="brand-card">
                {% if brand.logo %}
                <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo">
                {% else %}
                <span class="brand-name">{{ brand.name }}</span>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </section>
</div>

<script>
    // Initialize product list features after page load
    document.addEventListener('DOMContentLoaded', function () {
        // Import and initialize the product list module
        if (window.initProductList) {
            window.initProductList();
        }
    });

    // Re-initialize after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'resultsRoot') {
            // Re-initialize lazy loading and animations for new content
            if (window.initProductList) {
                window.initProductList();
            }
        }
    });
</script>
{% endblock %}