{% extends 'store/base.html' %}
{% load humanize static query_transform %}

{% block body_class %}categories-page{% endblock %}
{% block page_name %}categories{% endblock %}

{% block content %}
<div class="categories-container">

    <nav class="category-nav" aria-label="Filter by category">
        <div class="category-nav-list">
            {% for cat in categories %}
            <a href="{{ cat.get_absolute_url }}" class="category-tag {% if cat == category %}active{% endif %}">{{ cat.name }}</a>
            {% endfor %}
        </div>
    </nav>

    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">{% if category %}{{ category.name }}{% else %}Premium Gaming Products{% endif %}</h1>
            {% if category %}<p class="page-description">{{ category.description }}</p>{% endif %}
        </div>
        <div class="page-header-meta">
            <span class="product-count">{{ products.paginator.count }} Products</span>
        </div>
    </div>

    <div class="categories-layout">

        <button
            id="filterToggle"
            type="button"
            aria-expanded="false"
            aria-controls="filterContent"
            class="filter-toggle-btn"
        >
            <i class="fas fa-sliders-h" aria-hidden="true"></i>
            <span>Show Filters</span>
        </button>

        <aside class="filter-sidebar" id="filterSidebar" aria-label="Product Filters">

            <button class="filter-close-btn" aria-label="Close filters">
                <i class="fas fa-times"></i>
            </button>

            <div class="filter-content" id="filterContent" hidden>

                <div class="filter-header">
                    <h2>
                        <i class="fas fa-sliders-h filter-icon"></i>
                        Filters
                    </h2>
                    <a href="?{% query_transform max_price=None in_stock=None brand=None supplier=None min_rating=None sort=None %}"
                       class="reset-link">
                        Reset All
                    </a>
                </div>

                <div class="filter-section">
                    <h3>
                        <i class="fas fa-sort section-icon"></i>
                        Sort By
                    </h3>
                    <div class="sort-options">
                        {% for key, opt in sort_options.items %}
                        <a href="?{% query_transform sort=key page=None %}"
                           hx-get="?{% query_transform sort=key page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="sort-option {% if sort_by == key %}active{% endif %}">
                            <span>
                                <i class="fas {{ opt.icon }}"></i>
                                {{ opt.label }}
                            </span>
                            {% if sort_by == key %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-section">
                    <h3>
                        <i class="fas fa-dollar-sign section-icon"></i>
                        Price Range
                    </h3>
                    <div class="price-filter">
                        <input
                            type="range"
                            min="0"
                            max="100000"
                            value="{{ max_price|default:50000 }}"
                            id="priceRange"
                            class="price-slider"
                            aria-label="Maximum price"
                        >
                        <div class="price-display">
                            <span>0 KES</span>
                            <span id="priceDisplay">{{ max_price|default:"50,000" }} KES</span>
                        </div>
                        <button
                            class="apply-price-btn"
                            hx-get="?{% query_transform page=None %}"
                            hx-include="#priceRange"
                            hx-vals='js:{max_price: document.getElementById("priceRange").value}'
                            hx-target="#resultsRoot"
                            hx-swap="innerHTML"
                            hx-indicator="#grid-loading-spinner"
                            id="applyPriceBtn"
                        >
                            Apply Price
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>
                        <i class="fas fa-box section-icon"></i>
                        Availability
                    </h3>
                    <label class="stock-filter">
                        <input
                            type="checkbox"
                            id="inStock"
                            name="in_stock"
                            value="true"
                            class="stock-checkbox"
                            hx-get="?{% query_transform page=None %}"
                            hx-vals='js:{in_stock: document.getElementById("inStock").checked ? "true" : "false"}'
                            hx-target="#resultsRoot"
                            hx-swap="innerHTML"
                            hx-trigger="change"
                            hx-indicator="#grid-loading-spinner"
                            {% if in_stock %}checked{% endif %}
                            aria-label="Show in stock items only"
                        >
                        <span class="stock-label">In Stock Only</span>
                    </label>
                </div>

                </div>
            </aside>
        <main class="products-grid-container">
            <div id="grid-loading-spinner" class="htmx-indicator">
                <i class="fas fa-spinner fa-spin"></i>
            </div>

            <div class="products-grid" id="resultsRoot">
                {% include 'store/product/_results_grid.html' %}
            </div>
        </main>

    </div>
</div>

{% endblock %}