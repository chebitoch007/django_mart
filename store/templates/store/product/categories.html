{% extends 'store/base.html' %}
{% load humanize static query_transform %}

{% block body_class %}categories-page{% endblock %}
{% block page_name %}categories{% endblock %}

{% block content %}
<div class="categories-container">
    <div class="category-nav">
        <div class="category-nav-list">
            <a href="{% url 'store:product_list' %}" class="category-tag {% if not category %}active{% endif %}">All Products</a>
            {% for cat in categories %}
            <a href="{{ cat.get_absolute_url }}" class="category-tag {% if cat == category %}active{% endif %}">{{ cat.name }}</a>
            {% endfor %}
        </div>
    </div>

    <div class="page-header">
        <div>
            <h1 class="page-title">{% if category %}{{ category.name }}{% else %}Premium Gaming Products{% endif %}</h1>
            {% if category %}<p class="page-description">{{ category.description }}</p>{% endif %}
        </div>
        <div class="product-count">{{ products.paginator.count }} Products</div>
    </div>

    <div class="categories-layout">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar" id="filterSidebar" aria-label="Filters">
            <!-- Toggle Button for Mobile -->
            <button class="filter-toggle" id="filterToggle" aria-expanded="false">
                <i class="fas fa-filter"></i> <span>Show Filters</span>
            </button>

            <!-- Filters Content -->
            <div class="filter-content" id="filterContent" hidden>
                <div class="filter-header">
                    <h2><i class="fas fa-sliders-h"></i> Filters</h2>
                    <a href="?{% query_transform max_price=None in_stock=None brand=None supplier=None min_rating=None %}"
                       class="reset-link">Reset</a>
                </div>

<!-- Sort -->
<div class="filter-section">
  <h3><i class="fas fa-sort section-icon"></i> Sort By</h3>
  <div class="sort-options">
    {% for key, opt in sort_options.items %}
      <a
        hx-get="?{% query_transform sort=key page=None %}"
        hx-target="#resultsRoot"
        hx-swap="innerHTML"
        hx-indicator="#grid-loading-spinner"
        class="sort-option {% if sort_by == key %}active{% endif %}"
      >
        <i class="fas {{ opt.icon }}"></i> {{ opt.label }}
      </a>
    {% endfor %}
  </div>
</div>


                <!-- Price -->
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="price-filter">
                        <input type="range"
                               min="0"
                               max="1000"
                               value="{{ max_price|default:500 }}"
                               id="priceRange"
                               class="price-slider">
                        <div class="price-display">
                            <span>0 KES</span>
                            <span id="priceDisplay">{{ max_price|default:"500" }} KES</span>
                        </div>
                        <button class="apply-price-btn"
                                hx-get="?{% query_transform page=None %}"
                                hx-include="#priceRange"
                                hx-vals='js:{max_price: document.getElementById("priceRange").value}'
                                hx-target="#resultsRoot"
                                hx-swap="innerHTML"
                                hx-indicator="#grid-loading-spinner"
                                id="applyPriceBtn">
                            Apply
                        </button>
                    </div>
                </div>

                <!-- Rating -->
                <div class="filter-section">
                    <h3>Minimum Rating</h3>
                    <div class="rating-filter">
                        {% for i in "54321" %}
                        <a hx-get="?{% query_transform min_rating=i page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="rating-option {% if min_rating == i %}active{% endif %}">
                            {{ i }}â˜… & up
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Brands -->
                <div class="filter-section">
                    <h3>Brands</h3>
                    <div class="brand-filter">
                        {% for brand in brands %}
                        <a hx-get="?{% query_transform brand=brand.slug page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="brand-item {% if selected_brand == brand.slug %}active{% endif %}">
                            {{ brand.name }}
                            <span class="count">({{ brand.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Suppliers -->
                <div class="filter-section">
                    <h3>Suppliers</h3>
                    <div class="supplier-filter">
                        {% for sup in suppliers %}
                        <a hx-get="?{% query_transform supplier=sup.id page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="supplier-item {% if selected_supplier == sup.id|stringformat:'s' %}active{% endif %}">
                            {{ sup.name }}
                            <span class="count">({{ sup.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- In Stock -->
                <div class="filter-section">
                    <label class="stock-filter">
                        <input type="checkbox"
                               id="inStock"
                               name="in_stock"
                               value="true"
                               hx-get="?{% query_transform page=None %}"
                               hx-vals='js:{in_stock: document.getElementById("inStock").checked ? "true" : "false"}'
                               hx-target="#resultsRoot"
                               hx-swap="innerHTML"
                               hx-trigger="change"
                               hx-indicator="#grid-loading-spinner"
                               {% if in_stock %}checked{% endif %}>
                        <span class="stock-label">In Stock Only</span>
                    </label>
                </div>
            </div>
        </aside>


        <div class="products-grid" id="resultsRoot">
            {% include 'store/product/_results_grid.html' %}
        </div>
    </div>
</div>

<script src="{% static 'store/js/search.js' %}"></script>
{% endblock %}
