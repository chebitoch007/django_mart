{% extends 'store/base.html' %}
{% load humanize static query_transform %}

{% block body_class %}search-results-page{% endblock %}
{% block page_name %}search-results{% endblock %}

{% block extra_head %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="search-results-container">
  <div class="search-header">
    <h1 class="search-title">Search Results</h1>
    <p>Showing results for: <span class="search-query">"{{ query }}"</span></p>
    <div class="results-count">{{ products.paginator.count }} Items</div>

    <div class="active-filters" aria-live="polite">
      {% if request.GET.category %}
        <div class="filter-tag">Category: {{ request.GET.category }}
          <a href="?{% query_transform category=None %}" class="remove-filter" title="Remove category filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.max_price %}
        <div class="filter-tag">Max Price: KES {{ request.GET.max_price|intcomma }}
          <a href="?{% query_transform max_price=None %}" class="remove-filter" title="Remove price filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.min_rating %}
        <div class="filter-tag">Min Rating: {{ request.GET.min_rating }} stars
          <a href="?{% query_transform min_rating=None %}" class="remove-filter" title="Remove rating filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.in_stock %}
        <div class="filter-tag">In Stock Only
          <a href="?{% query_transform in_stock=None %}" class="remove-filter" title="Remove in-stock filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.brand %}
        <div class="filter-tag">Brand: {{ request.GET.brand }}
          <a href="?{% query_transform brand=None %}" class="remove-filter" title="Remove brand filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.supplier %}
        <div class="filter-tag">Supplier
          <a href="?{% query_transform supplier=None %}" class="remove-filter" title="Remove supplier filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="results-layout">
    <aside class="filter-sidebar" aria-label="Filters">
      <button class="filter-toggle" id="filterToggle" aria-expanded="false"> <i class="fas fa-filter"></i> Show Filters</button>
      <div class="filter-card" id="filterContent">
        <div class="filter-header">
          <h2 class="filter-title"><i class="fas fa-filter" aria-hidden="true"></i> Filters</h2>
          <a href="?q={{ query }}" class="reset-link">Reset All</a>
        </div>


<div class="filter-section">
  <h3 class="section-title"><i class="fas fa-sort section-icon"></i> Sort By</h3>
  <div class="sort-options">
    {% for key, opt in sort_options.items %}
      <a
        href="?{% query_transform sort=key %}"
        class="sort-option {% if sort_by == key %}active{% endif %}"
      >
        <i class="fas {{ opt.icon }}"></i> {{ opt.label }}
        {% if sort_by == key %}
          <i class="fas fa-check"></i>
        {% endif %}
      </a>
    {% endfor %}
  </div>
</div>


        <div class="filter-section">
          <h3 class="section-title"><i class="fas fa-tag section-icon" aria-hidden="true"></i> Price Range</h3>
          <div class="price-filter">
            <input type="range" class="price-slider" min="0" max="100000" id="priceRange" value="{{ max_price|default:'1000' }}">
            <div class="price-display"><span>0 KES</span> <span id="priceDisplay">{{ max_price|default:'1000' }} KES</span></div>
            <div class="price-inputs">
              <input type="number" id="minPriceInput" class="price-input" placeholder="Min" min="0">
              <input type="number" id="maxPriceInput" class="price-input" placeholder="Max" min="0" value="{{ max_price|default:'' }}">
              <button type="button" id="applyPriceBtn" class="apply-price-btn">Apply</button>
            </div>
          </div>
        </div>

        <div class="filter-section">
          <h3 class="section-title"><i class="fas fa-briefcase section-icon" aria-hidden="true"></i> Brands</h3>
          <div class="brand-filter" style="max-height:200px;overflow:auto;">
            {% for brand in brands %}
            <a href="?{% query_transform q=query brand=brand.slug page=None %}" class="brand-item">
              {% if brand.logo %}
                <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo-small">
              {% else %}
                <span class="brand-name">{{ brand.name }}</span>
              {% endif %}
              <span class="brand-count" aria-hidden="true">{{ brand.product_count }}</span>
            </a>
            {% endfor %}
          </div>
        </div>

        <div class="filter-section">
          <h3 class="section-title"><i class="fas fa-truck section-icon" aria-hidden="true"></i> Suppliers</h3>
          <div class="supplier-filter" style="max-height:160px;overflow:auto;">
            {% for sup in suppliers %}
            <a href="?{% query_transform q=query supplier=sup.id page=None %}" class="supplier-item">
              {{ sup.name }}
            </a>
            {% endfor %}
          </div>
        </div>

        <div class="filter-section">
          <h3 class="section-title"><i class="fas fa-box section-icon" aria-hidden="true"></i> Availability</h3>
          <div class="stock-filter">
            <input type="checkbox" id="inStock" class="stock-checkbox" {% if in_stock %}checked{% endif %}>
            <label for="inStock" class="stock-label">In Stock Only</label>
          </div>
        </div>

      </div>


<div class="sort-section">
  <h4>Sort By</h4>
  <form method="get" id="sortForm">
    <input type="hidden" name="q" value="{{ query }}">
    <select name="sort" onchange="this.form.submit()" class="sort-dropdown">
      {% for key, option in sort_options.items %}
        <option value="{{ key }}" {% if key == sort %}selected{% endif %}>
          <i class="fa {{ option.icon }}"></i> {{ option.label }}
        </option>
      {% endfor %}
    </select>
  </form>
</div>

    </aside>

    <div class="results-content" id="resultsRoot">
      {% include 'store/product/_results_grid.html' %}
    </div>
  </div>
</div>

<script src="{% static 'store/js/search.js' %}"></script>
{% endblock %}
