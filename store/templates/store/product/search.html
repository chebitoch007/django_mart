{% extends 'store/base.html' %}
{% load humanize static query_transform %}

{% block body_class %}search-results-page{% endblock %}
{% block page_name %}search-results{% endblock %}

{% block extra_head %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="search-results-container">
  <div class="search-header">
    <h1 class="search-title">Search Results</h1>
    <p>Showing results for: <span class="search-query">"{{ query }}"</span></p>
    <div class="results-count">{{ products.paginator.count }} Items</div>

    <div class="active-filters" aria-live="polite">
      {% if request.GET.category %}
        <div class="filter-tag">Category: {{ request.GET.category }}
          <a href="?{% query_transform category=None %}" class="remove-filter" title="Remove category filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.max_price %}
        <div class="filter-tag">Max Price: KES {{ request.GET.max_price|intcomma }}
          <a href="?{% query_transform max_price=None %}" class="remove-filter" title="Remove price filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.min_rating %}
        <div class="filter-tag">Min Rating: {{ request.GET.min_rating }} stars
          <a href="?{% query_transform min_rating=None %}" class="remove-filter" title="Remove rating filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.in_stock %}
        <div class="filter-tag">In Stock Only
          <a href="?{% query_transform in_stock=None %}" class="remove-filter" title="Remove in-stock filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.brand %}
        <div class="filter-tag">Brand: {{ request.GET.brand }}
          <a href="?{% query_transform brand=None %}" class="remove-filter" title="Remove brand filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.supplier %}
        <div class="filter-tag">Supplier
          <a href="?{% query_transform supplier=None %}" class="remove-filter" title="Remove supplier filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="results-layout">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar" id="filterSidebar" aria-label="Filters">
            <!-- Toggle Button for Mobile -->
            <button class="filter-toggle" id="filterToggle" aria-expanded="false">
                <i class="fas fa-filter"></i> <span>Show Filters</span>
            </button>

            <!-- Filters Content -->
            <div class="filter-content" id="filterContent" hidden>
                <div class="filter-header">
                    <h2><i class="fas fa-sliders-h"></i> Filters</h2>
                    <a href="?{% query_transform max_price=None in_stock=None brand=None supplier=None min_rating=None %}"
                       class="reset-link">Reset</a>
                </div>

<!-- Sort -->
<div class="filter-section">
  <h3><i class="fas fa-sort section-icon"></i> Sort By</h3>
  <div class="sort-options">
    {% for key, opt in sort_options.items %}
      <a
        hx-get="?{% query_transform sort=key page=None %}"
        hx-target="#resultsRoot"
        hx-swap="innerHTML"
        hx-indicator="#grid-loading-spinner"
        class="sort-option {% if sort_by == key %}active{% endif %}"
      >
        <i class="fas {{ opt.icon }}"></i> {{ opt.label }}
      </a>
    {% endfor %}
  </div>
</div>


                <!-- Price -->
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="price-filter">
                        <input type="range"
                               min="0"
                               max="1000"
                               value="{{ max_price|default:500 }}"
                               id="priceRange"
                               class="price-slider">
                        <div class="price-display">
                            <span>0 KES</span>
                            <span id="priceDisplay">{{ max_price|default:"500" }} KES</span>
                        </div>
                        <button class="apply-price-btn"
                                hx-get="?{% query_transform page=None %}"
                                hx-include="#priceRange"
                                hx-vals='js:{max_price: document.getElementById("priceRange").value}'
                                hx-target="#resultsRoot"
                                hx-swap="innerHTML"
                                hx-indicator="#grid-loading-spinner"
                                id="applyPriceBtn">
                            Apply
                        </button>
                    </div>
                </div>

                <!-- Rating -->
                <div class="filter-section">
                    <h3>Minimum Rating</h3>
                    <div class="rating-filter">
                        {% for i in "54321" %}
                        <a hx-get="?{% query_transform min_rating=i page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="rating-option {% if min_rating == i %}active{% endif %}">
                            {{ i }}â˜… & up
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Brands -->
                <div class="filter-section">
                    <h3>Brands</h3>
                    <div class="brand-filter">
                        {% for brand in brands %}
                        <a hx-get="?{% query_transform brand=brand.slug page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="brand-item {% if selected_brand == brand.slug %}active{% endif %}">
                            {{ brand.name }}
                            <span class="count">({{ brand.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Suppliers -->
                <div class="filter-section">
                    <h3>Suppliers</h3>
                    <div class="supplier-filter">
                        {% for sup in suppliers %}
                        <a hx-get="?{% query_transform supplier=sup.id page=None %}"
                           hx-target="#resultsRoot"
                           hx-swap="innerHTML"
                           hx-indicator="#grid-loading-spinner"
                           class="supplier-item {% if selected_supplier == sup.id|stringformat:'s' %}active{% endif %}">
                            {{ sup.name }}
                            <span class="count">({{ sup.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- In Stock -->
                <div class="filter-section">
                    <label class="stock-filter">
                        <input type="checkbox"
                               id="inStock"
                               name="in_stock"
                               value="true"
                               hx-get="?{% query_transform page=None %}"
                               hx-vals='js:{in_stock: document.getElementById("inStock").checked ? "true" : "false"}'
                               hx-target="#resultsRoot"
                               hx-swap="innerHTML"
                               hx-trigger="change"
                               hx-indicator="#grid-loading-spinner"
                               {% if in_stock %}checked{% endif %}>
                        <span class="stock-label">In Stock Only</span>
                    </label>
                </div>
            </div>



        </aside>

    <div class="results-content" id="resultsRoot">
      {% include 'store/product/_results_grid.html' %}
    </div>
  </div>
</div>

<script src="{% static 'store/js/search.js' %}"></script>
{% endblock %}
