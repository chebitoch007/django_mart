{% extends 'store/base.html' %}
{% load humanize static query_transform %}
{% load currency_tags %}


{% block body_class %}search-results-page{% endblock %}
{% block page_name %}search-results{% endblock %}

{% block extra_head %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="search-results-container">
  <div class="search-header">
    <h1 class="search-title">Search Results</h1>
    <p>Showing results for: <span class="search-query">"{{ query }}"</span></p>
    <div class="results-count">{{ products.paginator.count }} Items</div>

    <div class="active-filters" aria-live="polite">
      {% if request.GET.category %}
        <div class="filter-tag">Category: {{ request.GET.category }}
          <a href="?{% query_transform category=None %}" class="remove-filter" title="Remove category filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.max_price %}
        <div class="filter-tag">Max Price: KES {{ request.GET.max_price|intcomma }}
          <a href="?{% query_transform max_price=None %}" class="remove-filter" title="Remove price filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.min_rating %}
        <div class="filter-tag">Min Rating: {{ request.GET.min_rating }} stars
          <a href="?{% query_transform min_rating=None %}" class="remove-filter" title="Remove rating filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.in_stock %}
        <div class="filter-tag">In Stock Only
          <a href="?{% query_transform in_stock=None %}" class="remove-filter" title="Remove in-stock filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.brand %}
        <div class="filter-tag">Brand: {{ request.GET.brand }}
          <a href="?{% query_transform brand=None %}" class="remove-filter" title="Remove brand filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
      {% if request.GET.supplier %}
        <div class="filter-tag">Supplier
          <a href="?{% query_transform supplier=None %}" class="remove-filter" title="Remove supplier filter"><i class="fas fa-times"></i></a>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="results-layout">
<button
    id="filterToggle"
    type="button"
    aria-expanded="false"
    aria-controls="filterContent"
    class="filter-toggle-btn"
>
    <i class="fas fa-sliders-h" aria-hidden="true"></i>
    <span>Show Filters</span>
</button>

<aside class="filter-sidebar" id="filterSidebar" aria-label="Product Filters">

    <button class="filter-close-btn" aria-label="Close filters">
        <i class="fas fa-times"></i>
    </button>

    <div class="filter-content" id="filterContent" hidden>

        <div class="filter-header">
            <h2>
                <i class="fas fa-sliders-h filter-icon"></i>
                Filters
            </h2>
            <a href="?{% query_transform max_price=None in_stock=None brand=None supplier=None min_rating=None sort=None %}"
               class="reset-link">
                Reset All
            </a>
        </div>

        <div class="filter-section">
            <h3>
                <i class="fas fa-sort section-icon"></i>
                Sort By
            </h3>
            <div class="sort-options">
                {% for key, opt in sort_options.items %}
                <a href="?{% query_transform sort=key page=None %}"
                   hx-get="?{% query_transform sort=key page=None %}"
                   hx-target="#resultsRoot"
                   hx-swap="innerHTML"
                   hx-indicator="#grid-loading-spinner"
                   class="sort-option {% if sort_by == key %}active{% endif %}">
                    <span>
                        <i class="fas {{ opt.icon }}"></i>
                        {{ opt.label }}
                    </span>
                    {% if sort_by == key %}
                    <i class="fas fa-check" aria-hidden="true"></i>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="filter-section">
            <h3>
                <i class="fas fa-dollar-sign section-icon"></i>
                Price Range
            </h3>
            <div class="price-filter">
                <input
                    type="range"
                    min="0"
                    max="100000"
                    value="{{ max_price|default:50000 }}"
                    id="priceRange"
                    class="price-slider"
                    aria-label="Maximum price"
                >
                <div class="price-display">
                    <span>0 KES</span>
                    <span id="priceDisplay">{{ max_price|default:"50,000" }} KES</span>
                </div>

                <div class="price-inputs" style="display: none;">
                    <input
                        type="number"
                        id="minPriceInput"
                        class="price-input"
                        placeholder="Min"
                        min="0"
                        aria-label="Minimum price"
                    >
                    <input
                        type="number"
                        id="maxPriceInput"
                        class="price-input"
                        placeholder="Max"
                        aria-label="Maximum price"
                    >
                </div>

                <button
                    class="apply-price-btn"
                    hx-get="?{% query_transform page=None %}"
                    hx-include="#priceRange"
                    hx-vals='js:{max_price: document.getElementById("priceRange").value}'
                    hx-target="#resultsRoot"
                    hx-swap="innerHTML"
                    hx-indicator="#grid-loading-spinner"
                    id="applyPriceBtn"
                >
                    Apply Price
                </button>
            </div>
        </div>

        <div class="filter-section">
            <h3>
                <i class="fas fa-box section-icon"></i>
                Availability
            </h3>
            <label class="stock-filter">
                <input
                    type="checkbox"
                    id="inStock"
                    name="in_stock"
                    value="true"
                    class="stock-checkbox"
                    hx-get="?{% query_transform page=None %}"
                    hx-vals='js:{in_stock: document.getElementById("inStock").checked ? "true" : "false"}'
                    hx-target="#resultsRoot"
                    hx-swap="innerHTML"
                    hx-trigger="change"
                    hx-indicator="#grid-loading-spinner"
                    {% if in_stock %}checked{% endif %}
                    aria-label="Show in stock items only"
                >
                <span class="stock-label">In Stock Only</span>
            </label>
        </div>

        <div class="filter-section">
            <h3>
                <i class="fas fa-star section-icon"></i>
                Minimum Rating
            </h3>
            <div class="rating-filter">
                {% for i in "54321" %}
                <a href="?{% query_transform min_rating=i page=None %}"
                   hx-get="?{% query_transform min_rating=i page=None %}"
                   hx-target="#resultsRoot"
                   hx-swap="innerHTML"
                   hx-indicator="#grid-loading-spinner"
                   class="rating-option {% if min_rating == i %}active{% endif %}">
                    <span>
                        {% for star in "12345" %}
                            {% if forloop.counter <= i|add:0 %}
                            <i class="fas fa-star" aria-hidden="true"></i>
                            {% else %}
                            <i class="far fa-star" aria-hidden="true"></i>
                            {% endif %}
                        {% endfor %}
                        & up
                    </span>
                    {% if min_rating == i %}
                    <i class="fas fa-check" aria-hidden="true"></i>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>

        {% if brands %}
        <div class="filter-section">
            <h3>
                <i class="fas fa-tags section-icon"></i>
                Brands
            </h3>
            <div class="brand-filter">
                {% for brand in brands %}
                <a href="?{% query_transform brand=brand.slug page=None %}"
                   hx-get="?{% query_transform brand=brand.slug page=None %}"
                   hx-target="#resultsRoot"
                   hx-swap="innerHTML"
                   hx-indicator="#grid-loading-spinner"
                   class="brand-item {% if selected_brand == brand.slug %}active{% endif %}">
                    <span>
                        {% if brand.logo %}
                        <img src="{{ brand.logo.url }}"
                             alt="{{ brand.name }}"
                             class="brand-logo-small"
                             loading="lazy">
                        {% endif %}
                        {{ brand.name }}
                    </span>
                    <span class="brand-count">({{ brand.product_count }})</span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if suppliers %}
        <div class="filter-section">
            <h3>
                <i class="fas fa-truck section-icon"></i>
                Suppliers
            </h3>
            <div class="supplier-filter">
                {% for supplier in suppliers %}
                <a href="?{% query_transform supplier=supplier.id page=None %}"
                   hx-get="?{% query_transform supplier=supplier.id page=None %}"
                   hx-target="#resultsRoot"
                   hx-swap="innerHTML"
                   hx-indicator="#grid-loading-spinner"
                   class="supplier-item {% if selected_supplier == supplier.id|stringformat:'s' %}active{% endif %}">
                    <span>{{ supplier.name }}</span>
                    <span class="count">({{ supplier.product_count }})</span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if categories and show_category_filter %}
        <div class="filter-section">
            <h3>
                <i class="fas fa-folder section-icon"></i>
                Categories
            </h3>
            <div class="category-filter">
                {% for category in categories %}
                <a href="{{ category.get_absolute_url }}"
                   class="category-item {% if current_category == category %}active{% endif %}">
                    <span>
                        {% if category.icon %}
                        <i class="fas fa-{{ category.icon }}"></i>
                        {% endif %}
                        {{ category.name }}
                    </span>
                    <span class="count">({{ category.product_count }})</span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="filter-section">
            <h3>
                <i class="fas fa-tag section-icon"></i>
                Deals
            </h3>
            <label class="stock-filter">
                <input
                    type="checkbox"
                    id="onSale"
                    name="on_sale"
                    value="true"
                    class="stock-checkbox"
                    hx-get="?{% query_transform on_sale='true' page=None %}"
                    hx-target="#resultsRoot"
                    hx-swap="innerHTML"
                    hx-trigger="change"
                    hx-indicator="#grid-loading-spinner"
                    {% if on_sale %}checked{% endif %}
                    aria-label="Show items on sale only"
                >
                <span class="stock-label">On Sale Only</span>
            </label>
        </div>

        </div>
    </aside>
<div class="results-content" id="resultsRoot">
      {% include 'store/product/_results_grid.html' %}
    </div>
  </div>
</div>

{% endblock %}