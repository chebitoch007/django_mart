{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Modern Quick Edit Styles */
    .quick-edit-container {
        max-width: 1200px;
        margin: 20px auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .quick-edit-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 24px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .quick-edit-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .quick-edit-header .back-link {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .quick-edit-header .back-link:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .quick-edit-body {
        padding: 30px;
    }

    /* Form Sections */
    .form-section {
        margin-bottom: 32px;
        padding: 24px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .form-section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-section-title i {
        color: #3b82f6;
        font-size: 1.4rem;
    }

    /* Form Fields */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.full-width {
        grid-template-columns: 1fr;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        font-weight: 600;
        color: #334155;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-group label .required {
        color: #ef4444;
        font-weight: 700;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="url"],
    .form-group select,
    .form-group textarea {
        padding: 12px 16px;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
        /* --- CHANGED: Added !important to select --- */
        width: 100% !important;
        box-sizing: border-box;
        color: #111827;
    }

    /* --- ADDED: Fix for Select2 widgets (for category, brand, supplier) --- */
    .form-group .select2-container {
        width: 100% !important;
        box-sizing: border-box;
    }

    .form-group .select2-container .select2-selection {
        padding: 6px; /* Adjust padding to match other inputs */
        height: auto;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-group .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 28px; /* Align text vertically */
    }

    .form-group .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 48px; /* Match input height */
    }
    /* --- End of Select2 fixes --- */


    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group .select2-container.select2-container--focus .select2-selection {
         border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 120px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
    }

    .form-group .help-text {
        font-size: 0.85rem;
        color: #475569;
        margin-top: 4px;
    }

    /* Checkbox Styles */
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: white;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
    }

    .checkbox-group:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #3b82f6;
        width: auto;
    }

    .checkbox-group label {
        cursor: pointer;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }

    /* Special Field Styles */
    .currency-converter {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #3b82f6;
    }

    .feature-list-input {
        background: #f0f9ff;
        border: 2px solid #60a5fa;
        font-family: 'Monaco', 'Courier New', monospace;
    }

    .cta-input {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        font-weight: 600;
    }

    /* Character Counter */
    .char-counter {
        font-size: 0.8rem;
        color: #64748b;
        text-align: right;
        margin-top: 4px;
    }

    .char-counter.warning {
        color: #f59e0b;
        font-weight: 600;
    }

    .char-counter.danger {
        color: #ef4444;
        font-weight: 700;
    }

    /* Action Buttons */
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 24px 30px;
        background: #f8fafc;
        border-top: 2px solid #e2e8f0;
    }

    .btn {
        padding: 14px 28px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #334155;
    }

    .btn-secondary:hover {
        background: #cbd5e1;
    }

    /* Info Badges */
    .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .quick-edit-container {
            margin: 10px;
        }

        .quick-edit-header {
            flex-direction: column;
            gap: 12px;
            text-align: center;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Feature Preview */
    .feature-preview {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-top: 12px;
    }

    .feature-preview-title {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 12px;
        font-size: 0.95rem;
    }

    .feature-preview ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-preview li {
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .feature-preview li:last-child {
        border-bottom: none;
    }

    .feature-preview li i {
        color: #10b981;
        margin-top: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="quick-edit-container">
    <div class="quick-edit-header">
        <h1>
            <i class="fas fa-bolt"></i>
            Quick Edit: {{ product.name|truncatewords:5 }}
        </h1>
        <a href="{% url 'admin:store_product_changelist' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Products
        </a>
    </div>

    <form method="post" class="quick-edit-form">
        {% csrf_token %}

        <div class="quick-edit-body">

            <div class="form-section">
                <h2 class="form-section-title">
                    <i class="fas fa-info-circle"></i>
                    Basic Information
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">
                            Product Name <span class="required">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <span class="error">{{ form.name.errors }}</span>
                        {% endif %}
                        <span class="help-text">{{ form.name.help_text }}</span>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}">
                            Category <span class="required">*</span>
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <span class="error">{{ form.category.errors }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.brand.id_for_label }}">Brand</label>
                        {{ form.brand }}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.stock.id_for_label }}">
                            Stock Quantity <span class="required">*</span>
                        </label>
                        {{ form.stock }}
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.short_description.id_for_label }}">
                            Short Description
                        </label>
                        {{ form.short_description }}
                        <div class="char-counter" data-max="300" data-field="short_description">
                            0 / 300 characters
                        </div>
                        <span class="help-text">Brief product summary (max 300 characters)</span>
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}">
                            Full Description
                        </label>
                        {{ form.description }}
                        <span class="help-text">Detailed product description</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">
                    <i class="fas fa-star"></i>
                    Product Features & Marketing
                </h2>

                <div class="info-badge">
                    <i class="fas fa-lightbulb"></i>
                    These fields enhance product pages and improve SEO
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.features.id_for_label }}">
                            <i class="fas fa-check-circle"></i>
                            Product Features
                        </label>
                        {{ form.features }}
                        <span class="help-text">
                            <strong>Enter one feature per line.</strong> These will display as bullet points on the product page.
                            <br>Example:
                            <code>â€¢ 500 built-in classic games<br>â€¢ 8-bit handheld console<br>â€¢ Rechargeable battery</code>
                        </span>

                        <div class="feature-preview" id="featuresPreview" style="display: none;">
                            <div class="feature-preview-title">Preview:</div>
                            <ul id="featuresList"></ul>
                        </div>
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.cta.id_for_label }}">
                            <i class="fas fa-bullhorn"></i>
                            Call to Action (CTA)
                        </label>
                        {{ form.cta }}
                        <div class="char-counter" data-max="200" data-field="cta">
                            0 / 200 characters
                        </div>
                        <span class="help-text">
                            Compelling message to encourage purchases. Use emojis for impact!
                            <br>Example: <code>ðŸ•¹ Relive the classics â€” get your RetroPlayâ„¢ Console now!</code>
                        </span>
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.seo_keywords.id_for_label }}">
                            <i class="fas fa-search"></i>
                            SEO Keywords
                        </label>
                        {{ form.seo_keywords }}
                        <div class="char-counter" data-max="500" data-field="seo_keywords">
                            0 / 500 characters
                        </div>
                        <span class="help-text">
                            Comma-separated keywords for search engine optimization.
                            <br>Example: <code>retro handheld game console, 8-bit mini game player, portable gaming device</code>
                        </span>
                    </div>
                </div>
            </div>

            <div class="form-section currency-converter">
                <h2 class="form-section-title">
                    <i class="fas fa-dollar-sign"></i>
                    Pricing & Currency
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.input_currency.id_for_label }}">
                            Input Currency
                        </label>
                        {{ form.input_currency }}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.target_currency.id_for_label }}">
                            Convert To
                        </label>
                        {{ form.target_currency }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.input_price.id_for_label }}">
                            Regular Price
                        </label>
                        {{ form.input_price }}
                        <span class="help-text">Enter price in your selected currency</span>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.input_discount_price.id_for_label }}">
                            Discount Price
                        </label>
                        {{ form.input_discount_price }}
                        <span class="help-text">Optional sale price</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">
                    <i class="fas fa-shipping-fast"></i>
                    Shipping Information
                </h2>

                <div class.form-row>
                    <div class="info-badge" style="background: #fffbeb; color: #b45309; border: 1px solid #fde68a;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Shipping cost is entered in the <strong>Input Currency</strong> (e.g., USD) and will be converted.
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.shipping_cost.id_for_label }}">
                            Shipping Cost
                        </label>
                        {{ form.shipping_cost }}
                        <span class="help-text">Enter in <strong>Input Currency</strong>. Leave as 0 for free shipping.</span>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            {{ form.free_shipping }}
                            <label for="{{ form.free_shipping.id_for_label }}">
                                Free Shipping
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">
                    <i class="fas fa-boxes"></i>
                    Supplier Information
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.supplier.id_for_label }}">
                            Supplier
                        </label>
                        {{ form.supplier }}
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label for="{{ form.supplier_url.id_for_label }}">
                            Supplier Product URL
                        </label>
                        {{ form.supplier_url }}
                        <span class="help-text">Direct link to product on supplier's website</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">
                    <i class="fas fa-toggle-on"></i>
                    Product Status
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <div class="checkbox-group">
                            {{ form.available }}
                            <label for="{{ form.available.id_for_label }}">
                                Available for Purchase
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            {{ form.featured }}
                            <label for="{{ form.featured.id_for_label }}">
                                Featured Product
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </form>
</div>

<script src="https://kit.fontawesome.com/your-kit-id.js" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Fallback for icons if FontAwesome isn't loaded
    setTimeout(() => {
        if (document.querySelector('.fa-bolt') && window.getComputedStyle(document.querySelector('.fa-bolt')).fontFamily.toLowerCase().includes('fontawesome')) {
            // FontAwesome is loaded
        } else {
            // FontAwesome failed, use text fallbacks
            document.querySelectorAll('.fas.fa-bolt').forEach(el => el.textContent = 'âš¡');
            document.querySelectorAll('.fas.fa-arrow-left').forEach(el => el.textContent = 'â†');
            document.querySelectorAll('.fas.fa-info-circle').forEach(el => el.textContent = 'â„¹ï¸');
            document.querySelectorAll('.fas.fa-star').forEach(el => el.textContent = 'âœ¨');
            document.querySelectorAll('.fas.fa-check-circle').forEach(el => el.textContent = 'âœ“');
            document.querySelectorAll('.fas.fa-bullhorn').forEach(el => el.textContent = 'ðŸ“£');
            document.querySelectorAll('.fas.fa-search').forEach(el => el.textContent = 'ðŸ”');
            document.querySelectorAll('.fas.fa-dollar-sign').forEach(el => el.textContent = 'ðŸ’°');
            document.querySelectorAll('.fas.fa-shipping-fast').forEach(el => el.textContent = 'ðŸšš');
            document.querySelectorAll('.fas.fa-boxes').forEach(el => el.textContent = 'ðŸ“¦');
            document.querySelectorAll('.fas.fa-toggle-on').forEach(el => el.textContent = 'Toggle');
            document.querySelectorAll('.fas.fa-times').forEach(el => el.textContent = 'X');
            document.querySelectorAll('.fas.fa-save').forEach(el => el.textContent = 'Save');
            document.querySelectorAll('.fas.fa-lightbulb').forEach(el => el.textContent = 'ðŸ’¡');
            document.querySelectorAll('.fas.fa-exclamation-triangle').forEach(el => el.textContent = 'âš ï¸');
        }
    }, 500);


    // Character counter functionality
    function updateCharCounter(fieldName, maxChars) {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (!field) return;

        const counter = document.querySelector(`[data-field="${fieldName}"]`);
        if (!counter) return;

        function updateCount() {
            const length = field.value.length;
            counter.textContent = `${length} / ${maxChars} characters`;

            counter.classList.remove('warning', 'danger');
            if (length > maxChars) {
                counter.classList.add('danger');
            } else if (length > maxChars * 0.9) {
                counter.classList.add('warning');
            }
        }

        field.addEventListener('input', updateCount);
        updateCount();
    }

    updateCharCounter('short_description', 300);
    updateCharCounter('cta', 200);
    updateCharCounter('seo_keywords', 500);

    // Live preview for features
    const featuresField = document.querySelector('[name="features"]');
    const featuresPreview = document.getElementById('featuresPreview');
    const featuresList = document.getElementById('featuresList');

    if (featuresField && featuresPreview && featuresList) {
        featuresField.addEventListener('input', function() {
            const lines = this.value.split('\n').filter(line => line.trim());
            const icon = '<i class="fas fa-check-circle"></i>'; // Use icon here

            if (lines.length > 0) {
                featuresPreview.style.display = 'block';
                featuresList.innerHTML = lines.map(line => {
                    const cleaned = line.replace(/^[â€¢\-*]\s*/, '').trim();
                    return `<li>${icon} ${cleaned}</li>`;
                }).join('');
            } else {
                featuresPreview.style.display = 'none';
            }
        });
        featuresField.dispatchEvent(new Event('input'));
    }

    // Auto-sync free shipping checkbox with shipping cost
    const shippingCostField = document.querySelector('[name="shipping_cost"]');
    const freeShippingCheckbox = document.querySelector('[name="free_shipping"]');

    if (shippingCostField && freeShippingCheckbox) {

        function syncCheckboxToCost() {
            if (freeShippingCheckbox.checked) {
                shippingCostField.value = '0.00';
                shippingCostField.disabled = true;
            } else {
                shippingCostField.disabled = false;
            }
        }

        function syncCostToCheckbox() {
            // Use parseFloat for decimal check
            const cost = parseFloat(shippingCostField.value) || 0;
            if (cost === 0) {
                freeShippingCheckbox.checked = true;
            } else {
                freeShippingCheckbox.checked = false;
            }
        }

        freeShippingCheckbox.addEventListener('change', syncCheckboxToCost);

        shippingCostField.addEventListener('input', function() {
            syncCostToCheckbox();
            // Manually trigger the checkbox's 'change' event
            // to run its logic (which disables the cost field if checked)
            freeShippingCheckbox.dispatchEvent(new Event('change'));
        });

        // Run on initial page load
        syncCostToCheckbox();
        syncCheckboxToCost();
    }

    // Form validation
    const form = document.querySelector('.quick-edit-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const name = document.querySelector('[name="name"]');

            if (!name.value.trim()) {
                e.preventDefault();
                alert('Product name is required');
                name.focus();
                return false;
            }

            // Re-enable shipping cost field on submit if it was disabled
            if (shippingCostField && shippingCostField.disabled) {
                shippingCostField.disabled = false;
            }
        });
    }

    console.log('âœ… Quick Edit initialized');
});
</script>
{% endblock %}